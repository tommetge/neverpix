/* Copyright 2011-2013 33cube, Inc. All rights reserved. */
function Procrastination(){this.procrastinations||(this.procrastinations={})}
Procrastination.prototype.procrastinate=function(a,b,c,d){var e=this,f;_(b).isArray()||(b=[b]);_(c).isArray()||(c=[c]);b=_(b).filter(function(a){return _(a).isFunction()});e.procrastinations[a]?(clearTimeout(e.procrastinations[a].timeout),delete e.procrastinations[a].timeout):e.procrastinations[a]=$.extend({tasks:[],taskStrings:[],taskArgs:[]},$.Deferred());f=e.procrastinations[a];_(b).each(function(a){var b=a.toString(),d=_(f.taskStrings).indexOf(b);0>d?(f.tasks.push(a),f.taskStrings.push(b),f.taskArgs.push(c)):
$.extend(f.taskArgs[d],c)});f.timeout=setTimeout(function(){function b(){var a;f.tasks.length?(a=f.tasks.splice(0,1)[0].apply(e,f.taskArgs.splice(0,1)),f.taskStrings.splice(0,1),_(a).isObject()&&a.promise?a.done(b).fail(function(){f.reject()}):!1===a&&null===a?f.reject():b()):f.resolve()}delete e.procrastinations[a];b()},d||0);return f.promise()};Procrastination.prototype.abortProcrastinatedTasks=function(a){this.procrastinations[a]&&(clearTimeout(this.procrastinations[a].timeout),delete this.procrastinations[a])};
function RequestUtilities(){this.resources||(this.resources={})}RequestUtilities.prototype.makeParams=function(a,b){var c=this,d;if(c.resources[a])return d=_({}).extend(c.resources[a].params,b),_(d).each(function(a,b){_(a).isFunction()?d[b]=a.call(c):d[b]=a}),d;console.error("No such resource exists for this object:",a);return!1};function Strings(){this.strings||(this.strings={})}
Strings.prototype.makeString=function(a){var b=this.strings[a],c=_(arguments).tail(1);return _(b).isFunction()?b.apply(this,c):b};function Subscriptions(){this.subs||(this.subs={})}Subscriptions.prototype.subscribe=function(a,b,c,d){if(this.subs[a])return this.subs[a].topic===b&&this.subs[a].callback.toString()===c.toString()||console.error("Subscription overwrites previous callback:",c),!1;this.subs[a]={topic:b,callback:c};PubHub.sub(b,c,d||10);return!0};
Subscriptions.prototype.unsubscribe=function(){var a=this;_(arguments).each(function(b){a.subs[b]&&(PubHub.drubSub(a.subs[b].topic,a.subs[b].callback),delete a.subs[b])})};Subscriptions.prototype.unsubscribeAll=function(){this.unsubscribe(_(this.subs).keys())};function TaskQueue(){this.taskQueues||(this.taskQueues={})}
TaskQueue.prototype.queueTask=function(a,b,c){var d=this.taskQueues[a];d||(this.taskQueues[a]=d={queue:[],tasks:{}});if(!b)b="task-"+Math.floor(1E8*Math.random()).toString(16);else if(d.tasks[b])return console.error("ID conflict with another task:",b,d.tasks[b]),!1;d.tasks[b]=c;d.queue.push(c);return b};TaskQueue.prototype.dequeueTask=function(a,b){var c=this.taskQueues[a];return c&&b&&c.tasks[b]?(c.queue.splice(c.queue.indexOf(c.tasks[b]),1),delete c.tasks[b],!0):!1};
TaskQueue.prototype.executeAllTasks=function(a){var b=this,c=b.taskQueues[a];return c?(c=_(c.queue).map(function(a){return a.call(b)}),delete b.taskQueues[a],$.when.apply(b,c)):$.Deferred().reject()};TaskQueue.prototype.dequeueAllTasks=function(a){return this.taskQueues[a]?(delete this.taskQueues[a],!0):!1};function Templates(){this.templates||(this.templates={});this.$els||(this.$els={});this.buildDfds||(this.buildDfds={})}
Templates.prototype.buildElement=function(a,b,c){var d=this,e=$.Deferred(),f,g={};if(d.templates[a]){if(!d.buildDfds[a]||c)d.buildDfds[a]=$.Deferred(),_(g).extend(d.templates[a].options,b),_(g).each(function(a,b){_(a).isFunction()?g[b]=a.call(d):g[b]=a}),$(function(){f=d.templates[a].selector;_(f).isFunction()&&(f=f.call(d));d.$els[a]=d["$"+a]=$(f).mustache(g);d.buildDfds[a].resolve(d.$els[a])});e.follow(d.buildDfds[a])}else e.resolve(!1);return e.promise()};
Templates.prototype.destroyElement=function(a){return this.$els[a]?(this.$els[a].empty().remove(),delete this.$els[a],delete this["$"+a],delete this.buildDfds[a],!0):!1};Templates.prototype.destroyAllElements=function(){var a=this;_(a.$els).each(function(b,c){a.destroyElement(c)})};function Tracking(){this.analytics||(this.sessions=[])}
Tracking.prototype.startTrackingSession=function(){this.sessions.length&&!_(this.sessions).last().stop&&this.stopTrackingSession();this.sessions.push({start:$.now(),stop:void 0,duration:void 0,isLogged:!1})};Tracking.prototype.stopTrackingSession=function(a){var b=_(this.sessions).last();b.stop||(b.stop=a||$.now(),b.duration=b.stop-b.start,0>b.duration&&(b.duration=0))};
function Photo(a,b,c){var d=this;$.extend(d,{id:a,resources:{details:{resource:"photoDetails",params:{pid:a,nearbyPhotosLimit:FETCH_LIMIT_NEARBY,nearbyPhotos:"photos"}},edit:{resource:"photoEdit",params:{pid:a}},baleet:{resource:"photoDelete",params:{pid:a}},dumpID:{resource:"photoDumpID",params:{pid:a}},semanticFeedback:{resource:"semanticFeedback",params:{pid:a}}}},c,{isDestructed:!1,requests:{},largeSrcs:{}});d.thumbnailID=b.tid;d.unixTimestamp=b.timestamp?b.timestamp:null;d.timestamp=b.timestamp?
new XDate(1E3*b.timestamp,!0):null;d.width=b.width;d.height=b.height;d.aspectRatio=d.width/d.height;d.poi={x:b.poiX,y:b.poiY};d.visibility=b.visibility||0;d.orientation=b.orientation||1;d.semanticInfo=b.info||void 0;Procrastination.call(d);RequestUtilities.call(d);_.defer(function(){PubHub.pub("Item/construct",d)})}$.extend(!0,Photo.prototype,Procrastination.prototype,RequestUtilities.prototype);
Photo.prototype.getDetails=function(){var a=this;a.detailsDfd&&"rejected"!==a.detailsDfd.state()||(a.detailsDfd=$.Deferred(),a.requests.details=API.request(a.resources.details.resource,a.makeParams("details")).always(function(){delete a.requests.details}).done(function(b){var c=$.Deferred();a.originalTimestamp=b.originalTimestamp?new XDate(1E3*b.originalTimestamp,!0):null;a.orientation=b.orientation;a.details=$.extend({},b);a.details.captureDevice&&(a.details.captureDevice.make&&a.details.captureDevice.model?
0<=a.details.captureDevice.make.indexOf(a.details.captureDevice.model.split(" ")[0])?a.details.captureDevice.camera=a.details.captureDevice.model:a.details.captureDevice.camera=a.details.captureDevice.make+" "+a.details.captureDevice.model:a.details.captureDevice.camera=a.details.captureDevice.model);a.details.displaySources=_(a.details.sources).chain().map(function(a){return Sources.getMetaDetails(a)}).compact().value();a.details.nearbyPhotosDistancesMeters&&(a.details.nearbyPhotos=_(a.details.nearbyPhotosDistancesMeters).map(function(a,
b){return{photo:Photos.get(a[0].pid)||new Photo(a[0].pid,a[0],{}),distance:a[1]}}));a.details.location?(a.details.location.minimapURL=$.mustache(PHOTOVIEWER_MINIMAP_URL,a.details.location),a.details.location.mapLink=$.mustache(PHOTOVIEWER_MAP_LINK,a.details.location),a.details.location.description=$.mustache(PHOTOVIEWER_LATLONG_DESCRIPTION,{latitude:Math.abs(a.details.location.latitude),longitude:Math.abs(a.details.location.longitude),latitudeRef:1<a.details.location.latitude?"N":"S",longitudeRef:1<
a.details.location.longitude?"E":"W"}),Maps.getFriendlyLocation(a.details.location.latitude,a.details.location.longitude).always(function(b){a.details.location.name=b||void 0;c.resolve()})):c.resolve();$.when(c).always(function(){a.detailsDfd.resolve(a.details)})}).fail(function(){a.detailsDfd.reject()}));return a.detailsDfd.promise()};
Photo.prototype.clearDetails=function(){this.detailsDfd&&("pending"===this.detailsDfd.state()?(this.detailsDfd.reject(),this.requests.details&&this.requests.details.abort()):(delete this.detailsDfd,delete this.details))};
Photo.prototype.loadLarge=function(a,b){var c=this,d=$.Deferred(),e=Thumbnails.generateURL(c.thumbnailID,THUMBNAIL_FULL_SIZES[a]);$("<img/>",{load:function(){$(this).off("load error");d.resolve(e);if(!c.largeSrcs[a]||b)c.largeSrcs[a]=e,PubHub.pub("Photo/loadLarge",c,e)},error:function(){$(this).off("load error");d.reject()},src:e});return d.promise()};
Photo.prototype.setVisibility=function(a,b){function c(){d.visibility=a;PubHub.pub("Photo/set/visibility",d,a,g)}var d=this,e=$.Deferred(),f,g=d.visibility;d.visibility!==a?b?(c(),e.resolve()):d.requests.visibility||(f=d.makeParams("edit",{visibility:a}),d.requests.visibility=API.request(d.resources.edit.resource,f).always(function(){delete d.requests.visibility}).done(c),e.follow(d.requests.visibility)):e.resolve();return e.promise()};
Photo.prototype.hide=function(a){var b=this;return b.setVisibility(0,a).done(function(){PubHub.pub("Photo/hide",b)})};Photo.prototype.unhide=function(a){var b=this;return b.setVisibility(1,a).done(function(){PubHub.pub("Photo/unhide",b)})};
Photo.prototype.setOrientation=function(a){var b=this,c=b.orientation;return a!==b.orientation?(b.orientation=a,b.procrastinate("setOrientation",function(){var a=$.Deferred(),e;e=b.makeParams("edit",{orientation:b.orientation});API.request(b.resources.edit.resource,e).done(function(e){b.width=e.width;b.height=e.height;b.aspectRatio=b.width/b.height;b.poi={x:e.poiX,y:e.poiY};b.thumbnailID=e.tid;_(b.largeSrcs).each(function(a,c){b.loadLarge(c,!0)});PubHub.pub("Photo/set/orientation",b,b.orientation,
c);a.resolve(b.orientation,c)}).fail(function(){b.orientation=c;a.reject(c,c)});return a.promise()})):$.Deferred().reject(c,c).promise()};Photo.prototype.rotateClockwise=function(){var a=PHOTO_ROTATION_SEQUENCE.indexOf(this.orientation);0>a&&(a=1);PubHub.pub("Photo/rotate",this,"clockwise");return this.setOrientation(PHOTO_ROTATION_SEQUENCE[(a+8+2)%8])};
Photo.prototype.rotateCounterClockwise=function(){var a=PHOTO_ROTATION_SEQUENCE.indexOf(this.orientation);0>a&&(a=1);PubHub.pub("Photo/rotate",this,"counterclockwise");return this.setOrientation(PHOTO_ROTATION_SEQUENCE[(a+8-2)%8])};
Photo.prototype.editTimestamp=function(){var a=this,b=new XDate,c=$.Deferred(),d=!1,e=!1,f;f=$("#template-photo-editTimestamp").mustache({nowDate:b.toString(PHOTO_EDITTIMESTAMP_DATE_FORMAT),nowTime:b.toString(PHOTO_EDITTIMESTAMP_TIME_FORMAT),date:(a.timestamp?a.timestamp:b).toString(PHOTO_EDITTIMESTAMP_DATE_FORMAT),time:(a.timestamp?a.timestamp:b).toString(PHOTO_EDITTIMESTAMP_TIME_FORMAT),originalTimestamp:a.originalTimestamp&&a.originalTimestamp.getTime()!==a.timestamp.getTime()?a.originalTimestamp.toString(PHOTO_EDITTIMESTAMP_FULL_FORMAT):
!1,thumbnailSrc:Thumbnails.generateURL(a.thumbnailID,THUMBNAIL_SIZE_TINY)});f.appendTo("body").on({"afterOpen.popover":function(){f.find("input, textarea").filter(function(){return""===$(this).val()}).first().trigger("focus")},"beforeClose.popover":function(a){a.userTriggered&&c.reject()},"afterClose.popover":function(){f.popover().destruct()},"execute.asyncForm":function(){var b=new XDate($("#photo-editTimestamp\\/date").val()+" "+$("#photo-editTimestamp\\/time").val()+" Z",!0);d||b.valid()?a.setTimestamp(d?
"reset":b,!1,e).done(function(){c.resolve(b)}).fail(function(a,b){412===b?(e=!0,f.asyncForm().unlock().always(function(){f.trigger({type:"validate",validationData:{result:!1,message:"This photo will fall outside of your account's time window and become inaccessible. Are you sure you wish to continue?"}})})):f.asyncForm().unlock().always(function(){f.trigger({type:"validate",validationData:{result:!1,message:"Unexpected error, please try again. (code "+b+")"}})})}):f.asyncForm().unlock().always(function(){f.trigger({type:"validate",
validationData:{result:!1,message:"Invalid date format"}})})}});$("#photo-editTimestamp\\/date #photo-editTimestamp\\/time").on("change",function(){d=!1});$("#photo-editTimestamp\\/original").on("click",function(){$("#photo-editTimestamp\\/date").val(a.originalTimestamp?a.originalTimestamp.toString(PHOTO_EDITTIMESTAMP_DATE_FORMAT):"");$("#photo-editTimestamp\\/time").val(a.originalTimestamp?a.originalTimestamp.toString(PHOTO_EDITTIMESTAMP_TIME_FORMAT):"");d=!0;return new MessageBar(PHOTO_EDITTIMESTAMP_MESSAGE_RESET,
{extraClasses:"instructional",insertFunction:"appendTo",insertElement:f})});f.popover({isOpen:!0,closeButton:"back"});f.asyncForm();return c.done(function(b){PubHub.pub("Photo/editTimestamp",a,d?"reset":b)}).promise()};
Photo.prototype.setTimestamp=function(a,b,c){function d(a,b){a?(e.timestamp=a,e.unixTimestamp=b||a.getTime()/1E3):(e.timestamp=null,e.unixTimestamp=null);PubHub.pub("Photo/set/timestamp",e,a,k)}var e=this,f=$.Deferred(),g=!1,k=e.timestamp;"reset"!==a&&a instanceof XDate&&(!a.valid()||e.timestamp instanceof XDate&&e.timestamp.getTime()===a.getTime())?f.resolve():("reset"===a&&(g=!0,a=e.originalTimestamp),b||!a?(d(a),f.resolve()):e.requests.timestamp?f.follow(e.requests.timestamp):(a=e.makeParams("edit",
{timestamp:g?"reset":a.getTime()/1E3,force:c?1:0}),e.requests.timestamp=f.follow(API.request(e.resources.edit.resource,a).always(function(){delete e.requests.timestamp}).done(function(a){d(a.timestamp?new XDate(1E3*a.timestamp,!0):null,a.timestamp)}))));return f.promise()};Photo.prototype.resetTimestamp=function(a){return this.setTimestamp("reset",a)};
Photo.prototype.showFullInfo=function(){var a=this,b;b=$("#template-photo-fullInfo").mustache({}).appendTo("body").on({"afterClose.popover":function(){$(this).popover().destruct()}});b.popover({fixedTop:0.1,isOpen:!0});spinner=b.find(".spinner").spinner({showing:!0});a.requests.details=API.request("photoDetails",a.makeParams("details",{_debug:1})).always(function(){delete a.requests.details}).done(function(a){b.find("#photo-fullInfo\\/details").val(JSON.stringify(sortObject(a,!0),null,"  "))}).fail(function(){return new MessageBar(PHOTO_FULLINFO_ERROR,
{extraClasses:"alert",insertFunction:"appendTo",insertElement:b})});a.requests.dumpID=API.request("photoDumpID",a.makeParams("dumpID")).always(function(){delete a.requests.dumpID}).done(function(a){b.find("#photo-fullInfo\\/link").attr("href",Page.all.photoDump+"?id="+a.token).on("click",function(){b.popover().close(!0)})}).fail(function(){return new MessageBar(PHOTO_DUMPID_ERROR,{extraClasses:"alert",insertFunction:"appendTo",insertElement:b})});return $.when(a.requests.details,a.requests.dumpID).always(function(){spinner.hide().always(function(){spinner.destruct()});
b.find(".formField.hidden").removeClass("hidden")}).promise()};
Photo.prototype.baleet=function(a){function b(){return API.request(c.resources.baleet.resource,c.makeParams("baleet")).done(function(){d.popover().close();PubHub.pub("Photo/delete",c);c.destruct()})}var c=this,d,e=$.Deferred();a?(c.requests.baleet||(c.requests.baleet=b()),e.follow(c.requests.baleet.always(function(){delete c.requests.baleet}))):(d=$("#template-photo-deleteWarning").mustache({thumbnailSrc:Thumbnails.generateURL(c.thumbnailID,THUMBNAIL_SIZE_TINY)}).on({"beforeClose.popover":function(a){a.userTriggered&&
e.reject()},"afterClose.popover":function(){$(this).popover().destruct()},"execute.asyncForm":function(){e.follow(b())}}).appendTo("body"),d.popover({isOpen:!0,closeButton:"back"}),d.asyncForm(),d.find(".cancelLink").on("click",function(){d.popover().close(!0);e.reject()}));return e.promise()};Photo.prototype.destruct=function(){this.isDestructed=!0;PubHub.pub("Item/destruct",this);return $.resolved};
Photo.prototype.download=function(){Downloader.get(Thumbnails.generateURL(this.thumbnailID,THUMBNAIL_SIZE_DOWNLOAD));PubHub.pub("Photo/download",this)};
Photo.prototype.submitSemanticFeedback=function(a,b,c){function d(){var d;c||SEMANTIC_TAGS[a]?(d=$("#template-semanticFeedback-confirmation").mustache({title:SEMANTIC_TAGS[a]?SEMANTIC_TAGS[a].feedbackTitle:a,tagName:SEMANTIC_TAGS[a]?SEMANTIC_TAGS[a].title:a,thumbnailSrc:Thumbnails.generateURL(e.thumbnailID,THUMBNAIL_SIZE_TINY)}).on({"afterOpen.popover":function(){d.find("input:submit").trigger("focus")},"beforeClose.popover":function(a){a.userTriggered&&f.reject()},"afterClose.popover":function(){$(this).popover().destruct()},
"execute.asyncForm":function(){var g={};c?g.string=a:(g.semanticTags={},g.semanticTags[a]=b,g.semanticTags=JSON.stringify(g.semanticTags));API.request(e.resources.semanticFeedback.resource,e.makeParams("semanticFeedback",g));d.popover().close();f.resolve()}}).appendTo("body"),d.popover({isOpen:!0,closeButton:"back"}),d.asyncForm(),d.find(".cancelLink").on("click",function(){d.popover().close(!0);f.reject()})):f.reject()}var e=this,f=$.Deferred(),g;b=_(b).isNumber()?b:0;Cookie.getRemote(COOKIE_SEMANTICFEEDBACK_NAME)?
d():(g=$("#template-semanticFeedback-explanation").mustache().on({"beforeClose.popover":function(a){a.userTriggered&&f.reject()},"afterClose.popover":function(){$(this).popover().destruct()},"execute.asyncForm":function(){Cookie.setRemote(COOKIE_SEMANTICFEEDBACK_NAME,1);f.follow(d())}}).appendTo("body"),g.popover({isOpen:!0}),g.asyncForm(),g.find(".cancelLink").on("click",function(){g.popover().close(!0);f.reject()}));return f.promise()};
function Group(a){var b=this;$.extend(!0,b,{itemsDictionary:{},itemLimit:void 0,itemLimitTruncate:"last",isDestructed:!1,strings:{groupName:DEFAULT_GROUPNAME,itemName:DEFAULT_ITEMNAME,itemsName:DEFAULT_ITEMSNAME}});b.items=a||[];Subscriptions.call(b);Strings.call(b);_(b.items).each(function(a){a.id&&(b.itemsDictionary[a.id]=a)});b.subscribe("processItemConstruction","Item/construct",function(a){b.processItemConstruct(a)});b.subscribe("processItemDestruction","Item/destruct",function(a){b.processItemDestruct(a)})}
$.extend(!0,Group.prototype,Subscriptions.prototype,Strings.prototype);Group.prototype.match=function(a){return!0};Group.prototype.file=function(a){return this.items.length};
Group.prototype.add=function(a){var b=$.Deferred(),c;a&&!_(this.items).contains(a)?(c=this.file(a),!this.itemLimit||"last"===this.itemLimitTruncate&&c<this.itemLimit||"first"===this.itemLimitTruncate&&0<c?(this.items.splice(c,0,a),a.id&&(this.itemsDictionary[a.id]=a),PubHub.pub("Group/add",this,a),this.itemLimit&&this.items.length>=this.itemLimit?"first"===this.itemLimitTruncate?b.follow(this.remove(_(this.items).first())):b.follow(this.remove(_(this.items).last())):b.resolve(a)):b.reject()):b.reject();
return b.promise()};Group.prototype.remove=function(a){var b=_(this.items).indexOf(a);return 0<=b?(this.items.splice(b,1),a.id&&delete this.itemsDictionary[a.id],PubHub.pub("Group/remove",this,a),$.resolved):$.rejected};Group.prototype.refile=function(a){var b=_(this.items).indexOf(a),c;return 0<=b?(this.items.splice(b,1),c=this.file(a),this.items.splice(c,0,a),c!==b&&PubHub.pub("Group/refile",this,a),$.resolved):$.rejected};
Group.prototype.processItemConstruct=function(a){var b=$.Deferred();this.match(a)?b.follow(this.add(a)):b.reject();return b.promise()};Group.prototype.processItemDestruct=function(a){var b=$.Deferred();_(this.items).contains(a)?b.follow(this.remove(a)):b.reject();return b.promise()};
Group.prototype.reset=function(){var a=this,b;b=_(a.items).map(function(b){var d=$.Deferred();_(function(){a.remove(b).always(function(){d.resolve()})}).defer();return d});return $.when.apply(a,b).always(function(){PubHub.pub("Group/reset",a)}).promise()};Group.prototype.countItems=function(){return this.items.length};Group.prototype.hasItem=function(a){return!(_(a).isObject()?!_(this.items).contains(a):!this.itemsDictionary[a])};
Group.prototype.get=function(a){return a||0===a?this.itemsDictionary[a]:$.extend({},this.itemsDictionary)};Group.prototype.getMatching=function(a){return _(this.items).filter(a)};Group.prototype.countMatching=function(a){return this.getMatching(a).length};Group.prototype.getIndexOf=function(a){return _(this.items).indexOf(a)};Group.prototype.generateItemHash=function(){return _(this.items).pluck("id").join()};
Group.prototype.destruct=function(){this.isDestructed=!0;this.unsubscribeAll();this.items.splice(0);return $.resolved};function PhotoGroup(a,b){var c=this;Group.call(c,a);$.extend(!0,c,{sortOrder:"asc"},b);c.photos=c.items;c.subscribe("photoRefile","Photo/set/timestamp",function(a){_(c.items).contains(a)&&c.refile(a)})}$.extend(!0,PhotoGroup.prototype,Group.prototype);PhotoGroup.prototype.match=function(a){return a instanceof Photo};
PhotoGroup.prototype.file=function(a){var b=this;return _(b.items).sortedIndex(a,function(a){return(a.unixTimestamp||0)*("asc"===b.sortOrder?1:-1)})};function KeyPhotoGroup(a,b){PhotoGroup.call(this,a)}$.extend(!0,KeyPhotoGroup.prototype,PhotoGroup.prototype);KeyPhotoGroup.prototype.match=function(a){return!1};KeyPhotoGroup.prototype.file=function(a){return this.items.length};KeyPhotoGroup.prototype.processItemConstruct=function(){return $.rejected};
function Fetcher(a,b){var c=this;Group.call(c,a);$.extend(!0,c,{cursor:void 0,fetchContinue:!0,fetchedOnce:!1,resources:{fetchItems:{resource:"",params:{cursor:function(){return this.cursor},order:function(){return this.sortOrder}}}},respectSortOrderPref:!1,sortOrder:"asc"},b,{requests:{}});TaskQueue.call(c);RequestUtilities.call(c);_(function(){c.respectSortOrderPref&&c.setSortOrder(Preferences.get("sort_order"));c.subscribe("sortOrderPreference","Preference/set",function(a,b){c.respectSortOrderPref&&
"sort_order"===a&&c.setSortOrder(b)})}).defer()}$.extend(!0,Fetcher.prototype,TaskQueue.prototype,RequestUtilities.prototype,Group.prototype);Fetcher.prototype.processItemConstruct=function(){return $.rejected};Fetcher.prototype.reset=function(a){a=$.Deferred();this.isDestructed?a.reject():(this.cursor=void 0,this.fetchContinue=!0,this.fetchedOnce=!1,this.requests.fetch&&this.requests.fetch.abort(),a.follow(Group.prototype.reset.call(this)));return a.promise()};
Fetcher.prototype.fetch=function(a){var b=this,c=$.Deferred();b.isDestructed?c.reject():b.fetchContinue?(b.requests.fetch||(a=b.makeParams("fetchItems",a),b.requests.fetch=API.request(b.resources.fetchItems.resource,a).always(function(){b.fetchedOnce=!0;delete b.requests.fetch}).done(function(a){_(b.processFetchResponse(a)).each(function(a){b.add(a,"fetch")});PubHub.pub("Group/fetch",b)})),c.follow(b.requests.fetch)):c.resolve();return c.promise()};
Fetcher.prototype.processFetchResponse=function(a){this.cursor=a.cursor||null;this.fetchContinue=null!==this.cursor;return _(a.items).map(function(a){return a})};Fetcher.prototype.fetchAll=function(a){var b=this,c=$.Deferred();b.fetchContinue?b.fetch(a).done(function(){c.follow(b.fetchAll())}).fail(function(){c.reject()}):c.resolve();return c.promise()};
Fetcher.prototype.checkForUpdate=function(){function a(){var a=b.makeParams("fetchItems",{cursor:void 0});a.limit=Math.max(a.limit,b.items.length);b.requests.fetch=API.request(b.resources.fetchItems.resource,a).done(function(a){var c;newItems=b.processFetchResponse(a);a=_(newItems).difference(b.items);c=_(b.items).difference(newItems);_(a).each(function(a){b.add(a,"update")});_(c).each(function(a){b.remove(a,"update")})});c.follow(b.requests.fetch)}var b=this,c=$.Deferred();b.isDestructed?c.reject():
void 0===b.cursor?c.resolve():b.requests.fetch?b.requests.fetch.done(a):a();return c.promise()};Fetcher.prototype.setSortOrder=function(a){var b=$.Deferred();_(["asc","desc"]).contains(a)||(a="asc");a!==this.sortOrder?(this.sortOrder=a,b.follow(this.reset())):b.reject();return b.promise()};Fetcher.prototype.destruct=function(a){var b=this;return Group.prototype.destruct.call(b,a).done(function(){b.requests.fetch&&b.requests.fetch.abort()})};
function PhotoFetcher(a,b){PhotoGroup.call(this,a,b);Fetcher.call(this,a);$.extend(!0,this,{resources:{fetchItems:{resource:"",params:{limit:FETCH_LIMIT_PHOTOS}}}},b)}$.extend(!0,PhotoFetcher.prototype,PhotoGroup.prototype,Fetcher.prototype);PhotoFetcher.prototype.file=PhotoGroup.prototype.file;
PhotoFetcher.prototype.processFetchResponse=function(a){Fetcher.prototype.processFetchResponse.call(this,a);return _(a.photos).map(function(a){return!!window.Photos&&Photos.get(a.pid)||new Photo(a.pid,a,null,"fetch")})};
PhotoFetcher.prototype.selectItemForViewer=function(a,b){function c(){var c=d.items.length,e=f+c,m=d.items[e%c],n=void 0;m===a&&b?g.reject():(1<c&&(n=d.items[(e+1)%c]),g.resolve(m,n,0===e%c,e%c===c-1))}var d=this,e=_(d.items).indexOf(a),f,g=$.Deferred();b=0+b||0;e=a?_(d.items).indexOf(a):0;0<=e?(f=e+b,f>=d.items.length-1?d.fetch().always(c):0>f?d.fetchAll().always(c):c()):g.reject();return g.promise()};
function PublicPhotoPage(a,b,c,d){var e=this;PhotoFetcher.call(e,[]);$.extend(!0,e,{id:a,groupName:"Photo Page",resources:{fetchItems:{resource:"publicPhotoPageInfo",params:{sid:a}},download:{resource:"photoPageDownload",params:{sid:a}},baleet:!1},templates:{deleteWarning:!1}},d,{timestamp:null,photoCount:0});Templates.call(e);_(b).isObject()&&(e.timestamp=b.timestamp?new XDate(1E3*b.timestamp,!0):null,e.userName=b.userName);_(b).isObject()&&(e.timestamp=b.createdDate?new XDate(1E3*b.createdDate,
!0):null,e.photoCount=b.photoCount||0,e.visibility=void 0===b.visibility?1:b.visibility,e.title=b.title?b.title:e.timestamp?e.timestamp.toString(PHOTOPAGE_TITLE_DATE_FORMAT):!1,e.userName=b.userName||!1,e.allowDownload=!!b.allowDownload,_(b.keyPhotos).isArray()?e.keyPhotos=new KeyPhotoGroup(_(b.keyPhotos).map(function(a){return Photos.get(a.pid)||new Photo(a.pid,a,{},"keyPhotos")})):e.keyPhotos=new KeyPhotoGroup);_(c).isObject()&&(e.fetchedOnce=!0,_(e.processFetchResponse(c)).each(function(a){e.add(a,
"fetch")}),PubHub.pub("Group/fetch",e))}$.extend(!0,PublicPhotoPage.prototype,PhotoFetcher.prototype);PublicPhotoPage.prototype.match=function(){return!1};PublicPhotoPage.prototype.destruct=function(){return $.rejected};
PublicPhotoPage.prototype.download=function(){var a=this,b,c,d;b=$("#template-download").mustache({email:Query.email||Cookie.getLocal(COOKIE_EMAIL_NAME)||!1,photoCount:a.photoCount,isPlural:1!==a.photoCount}).appendTo("body");c=b.find(".card-thumbnails");_(a.photos).chain().first(5).each(function(a){var b=$("<span/>",{"class":"card-thumbnail"}).appendTo(c),d=Thumbnails.generateURL(a.thumbnailID,THUMBNAIL_SIZE_TINY);$("<img/>",{load:function(){$(this).off("load");b.css("backgroundImage","url('"+d+
"')")},src:d})});b.on({"afterOpen.popover":function(){b.find("input, textarea").filter(function(){return""===$(this).val()}).first().trigger("focus")},"afterClose.popover":function(){b.popover().destruct()},"execute.asyncForm":function(){var c=$("#download\\/email").val().match(REGEX_EMAIL)[0],f=a.makeParams("download",{email:c,forceEmail:c===d?1:0,createAccount:0,sendDownloadLink:1,copyToAccount:0});API.request(a.resources.download.resource,f).done(function(d,f){Cookie.setLocal(COOKIE_EMAIL_NAME,
c);b.popover().close();MessageBars.buildNew($.mustache(PHOTOPAGE_DOWNLOAD_SUCCESS,{isPlural:1!==a.photoCount}),{insertElement:$("body")})}).fail(function(a,f){b.asyncForm().unlock().always(function(){400===f?$("#download\\/email").trigger({type:"validate",validationData:{result:!1,message:"This is not a valid email address"}}):412===f?(d=c,$("#download\\/email").trigger({type:"validate",validationData:{result:!1,message:"Is this email address correct?"}})):b.trigger({type:"validate",validationData:{result:!1,
message:"Unexpected error, please try again. (code "+f+")"}})})})}});b.asyncForm();b.popover({isOpen:!0,autoCenter:!1})};
PublicPhotoPage.prototype.saveToCollection=function(a){var b=this,c,d,e;c=$("#template-saveToCollection").mustache({email:Query.email||Cookie.getLocal(COOKIE_EMAIL_NAME)||!1,photoCount:b.photoCount,isPlural:1!==b.photoCount}).appendTo("body");d=c.find(".card-thumbnails");_(b.photos).chain().first(5).each(function(a){var b=$("<span/>",{"class":"card-thumbnail"}).appendTo(d),c=Thumbnails.generateURL(a.thumbnailID,THUMBNAIL_SIZE_TINY);$("<img/>",{load:function(){$(this).off("load");b.css("backgroundImage",
"url('"+c+"')")},src:c})});c.find(".saveToCollection-switch").on("click",function(){c.attr("data-state",$(this).attr("data-stateTo"))});a&&c.find(".saveToCollection-switch[data-stateTo='"+a+"']")&&c.attr("data-state",a);c.on({"afterOpen.popover":function(){c.find("input, textarea").filter(function(){return""===$(this).val()}).first().trigger("focus")},"afterClose.popover":function(){c.popover().destruct()},"execute.asyncForm":function(){var a="new"===c.attr("data-state"),d=$("#saveToCollection\\/"+
(a?"new":"existing")+"\\/email").val().match(REGEX_EMAIL)[0],k=b.makeParams("download",{email:d,password:a?void 0:$("#saveToCollection\\/existing\\/password").val(),forceEmail:d===e?1:0,createAccount:a?1:0,sendDownloadLink:0,copyToAccount:1});API.request(b.resources.download.resource,k).done(function(e,m){var k=a?PHOTOPAGE_COPY_NEW_SUCCESS:$.mustache(PHOTOPAGE_COPY_EXISTING_SUCCESS,{isPlural:1!==b.photoCount});Cookie.setLocal(COOKIE_EMAIL_NAME,d);c.popover().close();MessageBars.buildNew(k,{insertElement:$("body")})}).fail(function(a,
b){c.asyncForm().unlock().always(function(){403===b?c.trigger({type:"validate",validationData:{result:!1,message:"Unknown email or invalid password"}}):400===b?$("#saveToCollection\\/new\\/email").trigger({type:"validate",validationData:{result:!1,message:"This is not a valid email address"}}):409===b?$("#saveToCollection\\/new\\/email").trigger({type:"validate",validationData:{result:!1,message:"This email address is already in use."}}):412===b?(e=d,$("#saveToCollection\\/new\\/email").trigger({type:"validate",
validationData:{result:!1,message:"Is this email address correct?"}})):c.trigger({type:"validate",validationData:{result:!1,message:"Unexpected error, please try again. (code "+b+")"}})})})}});c.asyncForm({validateTests:{requiredForState:{applyTo:function(){return this.is("[data-validation-requiredforstate]")&&this.data("validation-requiredforstate")===this.parents("form").attr("data-state")},testVal:function(){return this.is(":not(:checkbox, :radio)")&&this.val().length||$("input:radio[name='"+this.attr("name")+
"']:checked").length||this.is(":checked")?!0:!1},failureMessage:"This field is required"}}});c.popover({isOpen:!0,autoCenter:!1})};
function Grid(a,b,c){var d=this;Group.call(d,a);$.extend(!0,d,{id:_.uniqueId("grid-"),title:!1,templates:{grid:{selector:"#template-grid",options:{title:function(){return this.title||!1},dimHiddenItems:function(){return this.dimHiddenItems},isDim:function(){return this.isDim}}},coverMessage:{selector:"#template-grid-coverMessage"}},columnsPerRow:!1,previewSize:!1,rowLimit:!1,previewLimit:!1,respectSortOrderPref:!1,sortOrder:"asc",respectShowHiddenPref:!1,showHiddenItems:!0,fileByTimestamp:!0,rollingScroll:!0,
dimHiddenItems:!1,previewOptions:{}},c,{selecting:!1,chunks:[],insertQueue:[],loadableTop:null,loadableBottom:null,isActive:!1,isEmpty:void 0,isDim:!1,spotlights:[],dogEars:[]});d.previews=d.items;Procrastination.call(d);Subscriptions.call(d);TaskQueue.call(d);Templates.call(d);d.gridOf=b;_.defer(function(){d.subscribe("processGroupAdditions","Group/add",function(a,b){a===d.gridOf&&d.processGroupAddition(b)});d.subscribe("processGroupRemovals","Group/remove",function(a,b){a===d.gridOf&&d.processGroupRemoval(b)});
d.subscribe("groupRefilings","Group/refile",function(a,b){a===d.gridOf&&d.refile(b)});d.gridOf&&_(d.gridOf.items).each(function(a){d.add(a)});d.respectShowHiddenPref&&d.setShowHiddenItems(Preferences.get("show_hidden"));d.subscribe("showHiddenPreference","Preference/set",function(a,b){d.respectShowHiddenPref&&"show_hidden"===a&&d.setShowHiddenItems(b)});d.respectSortOrderPref&&d.setSortOrder(Preferences.get("sort_order"));d.subscribe("sortOrderPreference","Preference/set",function(a,b){d.respectSortOrderPref&&
"sort_order"===a&&d.setSortOrder(b)})});d.subscribe("processPreviewDestruction","Preview/destruct",function(a){0<=d.items.indexOf(a)&&d.remove(a)})}$.extend(!0,Grid.prototype,Group.prototype,Procrastination.prototype,Subscriptions.prototype,TaskQueue.prototype,Templates.prototype);Grid.prototype.match=function(a){return this.gridOf?this.gridOf.hasItem(a):!1};
Grid.prototype.file=function(a){var b=this;return b.fileByTimestamp?_(b.items).sortedIndex(a,function(a){return(a.previewOf.timestamp?a.previewOf.timestamp.getTime():0)*("asc"===b.sortOrder?1:-1)}):b.items.length};
Grid.prototype.add=function(a){var b=this,c;c=a.previewOf?a:Previews.buildNew(b.id+"/"+a.id,a,b.previewType,$.extend(b.previewOptions,{isAwake:!b.rollingScroll}));return Group.prototype.add.call(b,c).done(function(){c.toggleSpotlight(_(b.spotlights).contains(c.previewOf.id));c.toggleDogEar(_(b.dogEars).contains(c.previewOf.id));b.layout()})};
Grid.prototype.remove=function(a){var b=this,c=a.previewOf?a:Previews.get(b.id+"/"+a.id);return c?Group.prototype.remove.call(b,c).done(function(){b.detach(c).always(function(){c.destruct()}).fail(function(){b.layout()})}):$.rejected};Grid.prototype.refile=function(a){var b=this,c=a.previewOf?a:Previews.get(b.id+"/"+a.id);return c?Group.prototype.refile.call(b,c).done(function(){b.isActive&&b.detach(c)}):$.rejected};Grid.prototype.processItemConstruct=function(){return $.rejected};
Grid.prototype.processItemDestruct=function(){return $.rejected};Grid.prototype.destruct=function(){var a=this;return a.deactivate(!0).always(function(){a.destroyAllElements();_(a.previews).invoke("destruct");a.unsubscribeAll();_(function(){PubHub.pub("Grid/destruct",a)}).defer()})};Grid.prototype.processGroupAddition=function(a){return this.match(a)?this.add(a):$.rejected};Grid.prototype.processGroupRemoval=function(a){return this.getPreviewFor(a)?this.remove(a):$.rejected};
Grid.prototype.getPreviewFor=function(a){return this.get(this.id+"/"+a.id)};Grid.prototype.build=function(){var a=this;return a.buildElement("grid").done(function(){a.selecting&&a.setSelectionUI(!0)})};
Grid.prototype.activate=function(){var a=this,b=$.Deferred();!a.isActive&&a.$grid?(a.isActive=!0,a.layout().done(function(){var b;b=a.rollingScroll?_(a.chunks).where({inViewport:!0}):a.chunks;_(b).chain().pluck("previews").flatten().invoke("wake")}),a.subscribe("viewport","Viewport/update",function(b){b.deltas.columns||b.deltas.layoutSize||b.deltas.height&&a.rowLimit?a.layout(!0):(b.deltas.top||b.deltas.height)&&a.updateViewport()}),b.resolve()):b.reject();return b.promise()};
Grid.prototype.deactivate=function(a){var b=this,c=$.Deferred();b.isActive?(b.isActive=!1,a||b.updateViewport().always(function(){b.sleep()}),b.unsubscribe("viewport"),c.resolve()):c.reject();return c.promise()};
Grid.prototype.insert=function(a,b){var c=this,d=$.Deferred();a.inGrid||a.pendingInsert?d.reject():(a.pendingInsert=!0,a.build().done(function(){c.queueTask("insert",a.id,function(){for(var b=a.$preview,d=_(c.previews).indexOf(a),g,d=d-1;0<=d;d--)if(g=c.previews[d],g.inGrid){b.insertAfter(g.$preview);a.inGrid=!0;break}a.inGrid||(b.prependTo(c.$grid.find(".grid-contents").eq(0)),a.inGrid=!0);c.selecting&&(c.selectionHelper.shouldSelectAll||c.selectionHelper.selection.hasItem(a.previewOf))&&c.selectionHelper.select(a);
a.pendingInsert=!1;PubHub.pub("Grid/insert",c,a)})?d.follow(c.procrastinate("insertAll",function(){var a=$.Deferred();c.executeAllTasks("insert").always(function(){b||c.layout();a.resolve()});return a.promise()},[b])):d.reject()}).fail(function(){d.reject()}));return d.promise()};
Grid.prototype.detach=function(a,b){var c=this,d=$.Deferred(),e;a.inGrid||a.pendingInsert?a.pendingInsert?(c.dequeueTask("insert",a.id),a.pendingInsert=!1,d.resolve()):(e=c.queueTask("detach",a.id,function(){c.selecting&&c.selectionHelper.deselect(a);a.$preview.detach();a.inGrid=!1;PubHub.pub("Grid/detach",c,a)}))?d.follow(c.procrastinate("detachAll",function(){var a=$.Deferred();c.executeAllTasks("detach").always(function(){b||c.layout(!0);a.resolve()});return a.promise()})):d.reject():d.reject();
return d.promise()};
Grid.prototype.updateViewport=function(a){var b=this;return a||b.rollingScroll?b.procrastinate("updateViewport",function(a){var d,e=Viewport.getTop(),f=Viewport.getHeight(),g=e-f,f=e+f+f,k=[],l=[];b.$grid&&(d=b.$grid.offset().top,b.chunks.length&&(a||g!==b.loadableTop||f!==b.loadableBottom)&&(b.loadableTop=g,b.loadableBottom=f,_(b.chunks).each(function(a){d+a.outerHeight>=b.loadableTop&&d<=b.loadableBottom?!0!==a.inViewport&&(a.inViewport=!0,d+a.outerHeight>=e?_(a.previews).invoke("wake"):k.push(a)):
!1!==a.inViewport&&(a.inViewport=!1,l.push(a));d+=a.outerHeight}),_(k.reverse()).each(function(a){_(a.previews).invoke("wake")}),_(l).each(function(a){_(a.previews).invoke("sleep")})))},a,Viewport.isUpdatingHeavy()?100:0):$.rejected};Grid.prototype.getPreviewsForLayout=function(a){var b;b=this.showHiddenItems?this.previews:_(this.previews).filter(function(a){return!!a.previewOf.visibility});return a?_(b).first(a):b};Grid.prototype.getInsertedPreviews=function(){return _(this.previews).where({inGrid:!0})};
Grid.prototype.setSortOrder=function(a){var b=$.Deferred();_(["asc","desc"]).contains(a)||(a="asc");a!==this.sortOrder?(this.sortOrder=a,this.isActive?b.follow(this.layout()):b.resolve()):b.reject();return b.promise()};Grid.prototype.setShowHiddenItems=function(a){var b=$.Deferred();a=!!a;a!==this.showHiddenItems?(this.showHiddenItems=a,this.isActive?b.follow(this.layout()):b.resolve()):b.reject();return b.promise()};
Grid.prototype.layout=function(a){var b=this;if(b.$grid&&b.previews.length)return b.procrastinate("layout",function(a){var d=0,e,f,g,k,l,m;if(b.$grid&&b.previews.length){f=_(b).result("columnsPerRow")||Viewport.getColumns();g=_(b).result("previewSize")||Viewport.getLayoutSize();k=_(b).result("rowLimit")||!1;l=_(b).result("previewLimit")||!1;l=b.getPreviewsForLayout(l);m=b.getInsertedPreviews();if(!_(l).isEqual(m)||a)b.chunks=[],b.$grid.attr({"data-layout-size":g,"data-columns":f,"data-row-limit":k}),
_(m).chain().difference(l).each(function(a){b.detach(a,!0)}),_(l).each(function(a){if(!e||e.isFull){if(!1!==k&&d>=k)return b.detach(a,!0),!1;a.changeSize(g);e={previews:[],inViewport:void 0,totalColumns:0,rows:1,isFull:!1,outerHeight:a.dimensions.height+a.dimensions.marginBottom};b.chunks.push(e)}else a.changeSize(g);a.inGrid||a.pendingInsert||b.insert(a,!0);e.previews.push(a);e.totalColumns+=a.dimensions.columns;e.totalColumns>=f&&(e.isFull=!0,d+=e.rows);return!0});b.checkEmptiness();b.updateViewport(!0)}},
a);b.chunks=[];b.checkEmptiness();return $.rejected};Grid.prototype.measureHeight=function(){var a=0;_(this.chunks).each(function(b){a+=b.outerHeight});return a};Grid.prototype.checkEmptiness=function(){var a=!this.getPreviewsForLayout().length;this.isEmpty!==a&&(this.isEmpty=a,this.$grid&&this.$grid.toggleClass("empty",a),PubHub.pub("Grid/markEmpty",this,a));return this.isEmpty};Grid.prototype.wake=function(){_(this.previews).invoke("wake")};Grid.prototype.sleep=function(){_(this.previews).invoke("sleep")};
Grid.prototype.startSelection=function(a){var b=this;if(b.selecting)return!1;b.selecting=!0;b.selectionHelper={selection:a,shouldSelectAll:a.selectAll,select:function(b){a.add(b.previewOf);b.$preview&&b.$preview.addClass("selected")},deselect:function(b){a.remove(b.previewOf);b.$preview&&b.$preview.removeClass("selected")},toggle:function(c){a.hasItem(c.previewOf)?b.selectionHelper.deselect(c):b.selectionHelper.select(c)},selectAll:function(a){b.selectionHelper.shouldSelectAll=!0;a=a?_(b.getInsertedPreviews()).filter(function(a){return 0<
a.previewOf.visibility}):b.getInsertedPreviews();_(a).each(function(a){b.selectionHelper.select(a)})},deselectAll:function(){b.selectionHelper.shouldSelectAll=!1;_(b.getInsertedPreviews()).each(function(a){b.selectionHelper.deselect(a)})}};a.selectAll?b.selectionHelper.selectAll(!!b.dimHiddenItems):_(a.items).each(function(a){(a=b.getPreviewFor(a))&&b.selectionHelper.select(a)});b.subscribe("selectionAddition","Group/add",function(c,d){var e=b.getPreviewFor(d);c===a&&e&&b.selectionHelper.select(e)});
b.subscribe("selectionRemoval","Group/remove",function(c,d){var e=b.getPreviewFor(d);c===a&&e&&b.selectionHelper.deselect(e)});b.setSelectionUI(!0);return b.selectionHelper};
Grid.prototype.setSelectionUI=function(a){var b=this;return b.$grid?b.procrastinate("setSelectionUI",function(){a?(b.$grid.addClass("selectionMode"),b.$grid.on("click.selection",".preview .preview-checkMark",function(a){a=$(this).parents(".preview").data("previewOf");a=b.getPreviewFor(a);b.selectionHelper.toggle(a);return!1})):b.$grid.removeClass("selectionMode").off("click.selection")}):$.rejected};
Grid.prototype.endSelection=function(){var a,b;return this.selecting?(a=this.getSelectedPreviews(),b=_(a).pluck("previewOf"),this.selecting=!1,delete this.selectionHelper,this.unsubscribe("selectionAddition","selectionRemoval"),this.setSelectionUI(!1),_(a).each(function(a){a.$preview.removeClass("selected")}),b):!1};Grid.prototype.getSelectedPreviews=function(){return this.selecting?_(this.getInsertedPreviews()).filter(function(a){return a.$preview.hasClass("selected")}):[]};
Grid.prototype.scrollToItem=function(a){var b=this;a&&b.isActive&&b.layout().done(function(){var c=_(b.getInsertedPreviews()).find(function(b){return b.previewOf.id===a});c&&$.scrollTo(c.$preview,{offset:{top:-1*Math.max((Viewport.getHeight()-c.dimensions.height)/2,NAVBAR_HEIGHT+10)}})})};Grid.prototype.addSpotlight=function(a){a&&!_(this.spotlights).contains(a)&&(this.spotlights.push(a),_(this.previews).chain().filter(function(b){return b.previewOf.id===a}).invoke("toggleSpotlight",!0))};
Grid.prototype.removeSpotlight=function(a){var b=_(this.spotlights).indexOf(a);a&&0<=b&&(this.spotlights.splice(b,1),_(this.previews).chain().filter(function(b){return b.previewOf.id===a}).invoke("toggleSpotlight",!1))};Grid.prototype.addDogEar=function(a){a&&!_(this.dogEars).contains(a)&&(this.dogEars.push(a),_(this.previews).chain().filter(function(b){return b.previewOf.id===a}).invoke("toggleDogEar",!0))};
Grid.prototype.removeDogEar=function(a){var b=_(this.dogEars).indexOf(a);a&&0<=b&&(this.dogEars.splice(b,1),_(this.previews).chain().filter(function(b){return b.previewOf.id===a}).invoke("toggleDogEar",!1))};Grid.prototype.dim=function(){this.isDim=!0;this.$grid&&this.$grid.toggleClass("dim",this.isDim)};Grid.prototype.undim=function(){this.isDim=!1;this.$grid&&this.$grid.toggleClass("dim",this.isDim)};
Grid.prototype.buildCoverMessage=function(a){function b(){c.buildElement("coverMessage",a).done(function(b){c.dim();b.appendTo(c.$grid);if(a.dismissButton)b.on("click",function(){c.destroyCoverMessage()})}).fail(function(){d.reject()})}var c=this,d=$.Deferred();c.$coverMessage?c.destroyCoverMessage().always(b):b();return d.promise()};Grid.prototype.destroyCoverMessage=function(){return this.$coverMessage?(this.undim(),this.destroyElement("coverMessage"),$.resolved):$.rejected};
function PhotoGrid(a,b,c){var d=this;Grid.call(d,a,b,c);$.extend(!0,d,{dropCap:!1,dropCapsInChunk:function(a){return a?0:1},templates:{grid:{options:{extraClasses:"photoGrid"}}},previewType:"photo",handlePhotoViewer:!1},c);d.subscribe("photoVisibility","Photo/set/visibility",function(a){d.getPreviewFor(a)&&d.layout()});d.subscribe("photoOrientation","Photo/set/orientation",function(a){d.getPreviewFor(a)&&d.layout(!0)})}$.extend(!0,PhotoGrid.prototype,Grid.prototype);
PhotoGrid.prototype.file=function(a){var b=this;return b.fileByTimestamp?_(b.items).sortedIndex(a,function(a){return(a.previewOf.unixTimestamp||0)*("asc"===b.sortOrder?1:-1)}):b.items.length};PhotoGrid.prototype.build=function(){var a=this;return Grid.prototype.build.call(a).done(function(){if(a.$grid&&a.handlePhotoViewer)a.$grid.on("click",".photoPreview",function(){var b=Photos.get($(this).data("photo-id"));PhotoViewer.activate(b,a,!0);return!1})})};
PhotoGrid.prototype.deactivate=function(a){var b=this;return Grid.prototype.deactivate.call(b,a).done(function(){b.handlePhotoViewer&&(PhotoViewer.isActive&&PhotoViewer.supplier===b)&&PhotoViewer.deactivate(!0)})};
PhotoGrid.prototype.layout=function(a){var b=this;if(b.$grid&&b.previews.length)return b.procrastinate("layout",function(){function c(a,d,e){var h,k=0;_(a).each(function(a){var c={p:a,columns:a.naturalColumns};if(!h||h.isFull){if(!1!==g&&k>=g)return b.detach(a,!0),!0;a.changeSize(f);h={previewData:[],inViewport:void 0,rows:1,isFull:!1,numDropCaps:0,outerHeight:a.dimensions.height+a.dimensions.marginBottom};b.chunks.push(h)}else a.changeSize(f);a.inGrid||a.pendingInsert||b.insert(a,!0);h.previewData.push(c);
b.dropCap&&!e&&(!g||k+2<=g)&&(h.numDropCaps||0)<(_(b.dropCapsInChunk).isFunction()?b.dropCapsInChunk(_(b.chunks).indexOf(h)):b.dropCapsInChunk)&&(1===h.previewData.length||h.previewData[h.previewData.length-2].isDropCap)&&2*a.naturalColumns<(h.nonDropCapColumns||d)?(c.isDropCap=!0,c.columns*=2,h.rows=2,h.outerHeight=2*(a.dimensions.height+a.dimensions.marginBottom),h.numDropCaps=(h.numDropCaps||0)+1,h.dropCapColumns=(h.dropCapColumns||0)+c.columns,h.nonDropCapColumns=d-h.dropCapColumns,h.row1Columns=
0,h.row2Columns=0):h.totalColumns=(h.totalColumns||0)+c.columns;h.numDropCaps?(c.isDropCap||(h.row1Columns<h.nonDropCapColumns?(c.inRow1=!0,h.row1Columns+=c.columns):h.row2Columns<h.nonDropCapColumns&&(c.inRow2=!0,h.row2Columns+=c.columns)),h.row1Columns>=h.nonDropCapColumns&&h.row2Columns>=h.nonDropCapColumns&&(h.isFull=!0,k+=h.rows)):h.totalColumns&&h.totalColumns>=d&&(h.isFull=!0,k+=h.rows);return!0});h.numDropCaps&&!h.isFull&&(b.chunks.pop(),c(_(h.previewData).pluck("p"),d,!0))}function d(a,b,
c){var d,e;b-=c;c=0;d=1;for(e=_(a).chain().pluck("columns").max().value();0<b;)a[c].columns===e&&(a[c].columns--,b--),0<d?c>=a.length-1?(d=-1,e--):c++:0>=c?(d=1,e--):c--}var e,f,g,k,l;if(b.$grid&&b.previews.length){e=_(b).result("columnsPerRow");_(e).isNumber()||(e=Viewport.getColumns());f=_(b).result("previewSize")||Viewport.getLayoutSize();g=_(b).result("rowLimit")||!1;k=_(b).result("previewLimit");_(k).isNumber()||(k=void 0);k=b.getPreviewsForLayout(k);l=b.getInsertedPreviews();if(!_(k).isEqual(l)||
a)b.chunks=[],b.queueTask("layoutGrid","gridAttributes",function(){b.$grid.attr({"data-layout-size":f,"data-columns":e,"data-row-limit":g})}),_(l).chain().difference(k).each(function(a){b.detach(a,!0)}),c(k,e),_(b.chunks).each(function(a){a.numDropCaps?(d(_(a.previewData).where({inRow1:!0}),a.row1Columns,a.nonDropCapColumns),d(_(a.previewData).where({inRow2:!0}),a.row2Columns,a.nonDropCapColumns)):d(a.previewData,a.totalColumns,e);_(a.previewData).each(function(a){b.queueTask("layoutGrid",a.p.id,
function(){a.p.setColumns(a.columns);a.p.toggleDropCap(!!a.isDropCap)})});a.previews=_(a.previewData).pluck("p");delete a.previewData}),b.executeAllTasks("layoutGrid");b.checkEmptiness();b.updateViewport(!0)}},[a]);b.chunks=[];b.checkEmptiness();return $.rejected};PhotoGrid.prototype.getPhotosForViewer=function(){return _(this.getInsertedPreviews()).chain().filter(function(a){return a.previewOf instanceof Photo}).pluck("previewOf").value()};
PhotoGrid.prototype.selectItemForViewer=function(a,b){var c,d,e,f,g,k=$.Deferred();b=0+b||0;c=_(this.getInsertedPreviews()).pluck("previewOf");d=c.length;e=a?_(c).indexOf(a):0;0<=e?(e=e+b+d,f=c[e%d],g=void 0,f===a&&b?k.reject():(1<d&&(g=c[(e+1)%d]),k.resolve(f,g,0===e%d,e%d===d-1))):k.reject();return k.promise()};
function SinglePhotoGrid(a,b,c){var d=this;PhotoGrid.call(d,a,b,c);$.extend(!0,d,{templates:{grid:{options:{extraClasses:"singlePhoto"}}}},c,{itemLimitTruncate:"first",title:!1,columnsPerRow:1,previewSize:"single",rowLimit:1,fileByTimestamp:!1,rollingScroll:!1,dropCap:!1,previewType:"singlePhoto"});d.subscribe("photoVisibility","Photo/set/visibility",function(a){d.getPreviewFor(a)&&d.layout()});d.subscribe("photoOrientation","Photo/set/orientation",function(a){d.getPreviewFor(a)&&d.layout(!0)})}
$.extend(!0,SinglePhotoGrid.prototype,PhotoGrid.prototype);SinglePhotoGrid.prototype.build=function(){var a=this;return Grid.prototype.build.call(a).done(function(){if(a.$grid&&a.allowPhotoViewer)a.$grid.on("click",".photoPreview",function(){a.openPhotoViewer($(this).data("photo-id"));return!1})})};SinglePhotoGrid.prototype.updateViewport=function(){return!1};
SinglePhotoGrid.prototype.layout=function(a){var b=this;if(b.$grid&&b.previews.length)return b.procrastinate("layout",function(){var c;if(b.$grid&&b.previews.length){if((c=b.getPreviewsForLayout()[0])||a)b.$grid.attr({"data-layout-size":b.previewSize,"data-columns":b.columnsPerRow,"data-row-limit":b.rowLimit}),c&&!c.inGrid&&(b.insert(c,!0),b.rows=[{previews:[c]}]);b.checkEmptiness()}});b.rows=[];b.checkEmptiness();return $.rejected};
function Preview(a,b,c){$.extend(!0,this,{templates:{preview:{options:{isHidden:function(){return!this.previewOf.visibility},isSpotlight:function(){return this.isSpotlight},isDogEarred:function(){return this.isDogEarred},size:function(){return this.size}}}},isAwake:!0,size:null},c,{id:a,builtOnce:!1,inGrid:!1,isSpotlight:!1,isDogEarred:!1});this.previewOf=b;this.prototypeDimensions=Preview.prototype.dimensions;this.dimensions=$.extend({},this.prototypeDimensions[this.size]);Subscriptions.call(this);
Templates.call(this);Strings.call(this)}$.extend(!0,Preview.prototype,Subscriptions.prototype,Templates.prototype,Strings.prototype);Preview.prototype.dimensions={};Preview.prototype.build=function(){var a=this,b=a.$preview;return a.constructPreview().done(function(c){c&&(a.$preview=c,c.data("previewOf",a.previewOf),b&&b.empty().replaceWith(a.$preview),a.isAwake&&(a.isAwake=!1,a.wake()),a.builtOnce?PubHub.pub("Preview/rebuild",a,a.previewOf):(a.builtOnce=!0,PubHub.pub("Preview/build",a,a.previewOf)))})};
Preview.prototype.constructPreview=function(){return this.buildElement("preview",null,!0)};Preview.prototype.changeSize=function(a){return a!==this.size&&this.prototypeDimensions[a]?(this.size=a,this.dimensions=$.extend({},this.prototypeDimensions[this.size]),this.build(),!0):!1};Preview.prototype.destruct=function(){var a=this;a.unsubscribeAll();a.$preview&&a.$preview.empty().remove();_(function(){PubHub.pub("Preview/destruct",a,a.previewOf)}).defer();return $.resolved};
Preview.prototype.toggleSpotlight=function(a){this.isSpotlight!==a&&(this.isSpotlight=!!a,this.$preview&&this.$preview.toggleClass("spotlight",!!a))};Preview.prototype.toggleDogEar=function(a){this.isDogEarred!==a&&(this.isDogEarred=!!a,this.$preview&&this.$preview.toggleClass("dogEarred",!!a))};Preview.prototype.wake=function(){this.isAwake||(this.isAwake=!0)};Preview.prototype.sleep=function(){this.isAwake&&(this.isAwake=!1)};
function PhotoPreview(a,b,c){var d=this;Preview.call(d,a,b,c);$.extend(!0,d,{features:{hide:!1,feedback:!1,dateTray:!1,relativeDate:!0,absoluteDate:!0,jumpToMoment:!0,todayDate:!1},templates:{preview:{selector:"#template-photoPreview",options:{photoID:b.id,columns:function(){return this.columns},isDropCap:function(){return this.isDropCap},features:function(){var a=$.extend({},this.features);a.jumpToMoment=a.jumpToMoment&&!!this.previewOf.timestamp;return a},relativeDate:function(){return this.previewOf.timestamp instanceof
XDate?this.previewOf.timestamp.relativeToNow():PHOTO_UNDATED_TITLE},absoluteDate:function(){return this.previewOf.timestamp instanceof XDate?this.previewOf.timestamp.toString(PHOTO_PREVIEW_DATE_FORMAT):!1},yearsAgo:function(){return this.previewOf.timestamp instanceof XDate?this.previewOf.timestamp.relativeToNow("year",null,"year",null):!1},dayOfWeek:function(){return this.previewOf.timestamp instanceof XDate?this.previewOf.timestamp.toString("dddd, MMM d"):!1}}}},isAwake:!1,size:"standard",columns:2},
c,{isDropCap:!1,thumbnailSrc:null});d.prototypeDimensions=PhotoPreview.prototype.dimensions;d.dimensions=$.extend({},d.prototypeDimensions[d.size]);d.updateNaturalColumns();d.subscribe("photoVisibility","Photo/set/visibility",function(a,b){a===d.previewOf&&d.$preview&&d.$preview.toggleClass("hidden",!b)});d.subscribe("photoOrientation","Photo/set/orientation",function(a,b){a===d.previewOf&&d.$preview&&(d.updateNaturalColumns(),d.build())});d.subscribe("photoTimestamp","Photo/set/timestamp",function(a,
b){var c=d.templates.preview.options.includeDate;a===d.previewOf&&(d.$previewv&&(_(c).isFunction()?c():c))&&d.build()})}$.extend(!0,PhotoPreview.prototype,Preview.prototype);PhotoPreview.prototype.dimensions={standard:{width:0,height:225,marginLeft:12,marginBottom:12,columnWidth:66},small:{width:0,height:138,marginLeft:8,marginBottom:8,columnWidth:40},mini:{width:0,height:113,marginLeft:4,marginBottom:4,columnWidth:35}};
PhotoPreview.prototype.build=function(){var a=this,b=a.$preview?a.$preview.hasClass("selected"):!1;return Preview.prototype.build.call(a).done(function(c){a.$preview.toggleClass("selected",b)})};
PhotoPreview.prototype.constructPreview=function(){var a=this,b=a.previewOf;return a.buildElement("preview",{},!0).done(function(c){var d,e;c.width(a.dimensions.width);c.on("click",function(a){return a.altKey?(b.showFullInfo(),!1):!0});a.features.hide&&(c.find(".photoPreview-visibilityControls").on("click",function(){return!1}),d=c.find(".photoPreview-visibilityControls .spinner").spinner(),c.find(".photoPreview-hide").on("click",function(){c.addClass("visibilityPending");d.show();b.hide().always(function(){c.removeClass("visibilityPending");
d.hide()})}),c.find(".photoPreview-show").on("click",function(){c.addClass("visibilityPending");d.show();b.unhide().always(function(){c.removeClass("visibilityPending");d.hide()})}));a.features.feedback&&!Modernizr.touch&&(e=c.find(".photoPreview-feedback > .bubble").bubble(),c.find(".photoPreview-feedback").on({mouseenter:function(){e.open()},mouseleave:function(){e.close()}}));if(a.features.jumpToMoment)c.find(".photoPreview-jumpTo").on("click",function(){Moments.jumpTo(a.previewOf.id).fail(function(){MessageBars.buildNew(MOMENT_JUMPTO_MESSAGE_ERROR,
{extraClasses:"alert"})});return!1});a.$frame=c.find(".photoPreview-frame");a.$thumbnail=a.$frame.find(".photoPreview-thumbnail").detach()})};PhotoPreview.prototype.setWidth=function(a){this.dimensions.width!==a&&(this.dimensions.width=a,this.$preview&&this.$preview.width(a))};PhotoPreview.prototype.setColumns=function(a){this.columns=a;this.setWidth((this.dimensions.columnWidth+this.dimensions.marginLeft)*a-this.dimensions.marginLeft);this.$preview&&this.$preview.attr("data-columns",a)};
PhotoPreview.prototype.updateNaturalColumns=function(){this.naturalColumns=1>this.previewOf.aspectRatio?2:1.333>this.previewOf.aspectRatio?3:1.7>this.previewOf.aspectRatio?4:5};PhotoPreview.prototype.toggleDropCap=function(a){this.isDropCap!==a&&(this.isDropCap=!!a,this.$preview&&(this.$preview.toggleClass("dropCap",!!a),this.buildThumbnail()))};
PhotoPreview.prototype.buildThumbnail=function(){var a=this,b=Thumbnails.generateURL(a.previewOf.thumbnailID,a.isDropCap?THUMBNAIL_SIZE_PHOTOPREVIEW_DROPCAP:THUMBNAIL_SIZE_PHOTOPREVIEW);a.thumbnailSrc=b;Thumbnails.queueDownload(b).done(function(){var c=a.$thumbnail.css("backgroundImage");$(this).off("load");a.isAwake&&a.thumbnailSrc===b&&(a.$thumbnail.css("backgroundImage","url('"+b+"')").appendTo(a.$frame),!Modernizr.cssanimations||(Viewport.isUpdating()||c)||(a.$thumbnail.addClass("justLoaded"),
setTimeout(function(){a.$thumbnail.removeClass("justLoaded")},IMAGE_FADEIN_DURATION)))})};PhotoPreview.prototype.wake=function(){var a=this;a.isAwake||(a.isAwake=!0,Viewport.isUpdating()?setTimeout(function(){a.isAwake&&a.buildThumbnail()},200):a.buildThumbnail())};PhotoPreview.prototype.sleep=function(){this.isAwake&&(this.isAwake=!1,this.$thumbnail&&(this.$thumbnail.detach(),Thumbnails.dequeueDownload(this.thumbnailSrc)))};
function SinglePhotoPreview(a,b,c){PhotoPreview.call(this,a,b,c);$.extend(!0,this,{tag:null,features:{relativeDate:!1,absoluteDate:!1,jumpToMoment:!1},templates:{preview:{selector:"#template-singlePhotoPreview"}}},c,{isAwake:!0,size:"single",columns:null,allowSizes:[480,800]});this.prototypeDimensions=null;this.dimensions={}}$.extend(!0,SinglePhotoPreview.prototype,PhotoPreview.prototype);
SinglePhotoPreview.prototype.buildThumbnail=function(){var a=this,b;_(a.allowSizes).each(function(c,d){return c>=Viewport.getWidth()||d===a.allowSizes.length-1?(b=Thumbnails.generateURL(a.previewOf.thumbnailID,THUMBNAIL_FULL_SIZES[c]),!1):!0});a.thumbnailSrc=b;BlockingActivity.show("singlePhoto",PHOTO_THUMBNAIL_LOADING);$("<img/>",{load:function(){var c=a.$preview.attr("src");$(this).off("load error");BlockingActivity.hide("singlePhoto");a.isAwake&&a.thumbnailSrc===b&&(a.$preview.attr("src",b),!Modernizr.cssanimations||
(Viewport.isUpdating()||c)||(a.$preview.addClass("justLoaded"),setTimeout(function(){a.$preview.removeClass("justLoaded")},IMAGE_FADEIN_DURATION)))},error:function(){BlockingActivity.hide("singlePhoto")},src:b})};SinglePhotoPreview.prototype.setWidth=$.noop;SinglePhotoPreview.prototype.setColumns=$.noop;SinglePhotoPreview.prototype.toggleDropCap=$.noop;
function View(a,b){var c=this;$.extend(!0,c,{id:a,activateImmediately:!1,viewClass:null,state:null,allowedStates:[],skipBreadcrumbs:!1,features:{sharing:!1,slideshow:!1},templates:{view:{selector:"#template-view",options:{id:a,hasFootnoteNavigation:function(){return this.hasFootnoteNavigation}}},footer:!1},lobbyView:null,isLobbyView:!1,navBarSections:{left:"default",center:"default",right:"default"},navDrawerTags:{viewType:a,filterType:!1},showGlobalFooter:!0,hasFootnoteNavigation:!1,strings:{title:VIEW_TITLE,
footnoteNavigationTitle:function(){return this.makeString("title")}}},b,{isActive:!1,isDestructed:!1,scrollPosition:0});Strings.call(c);Subscriptions.call(c);Templates.call(c);Tracking.call(c);_.defer(function(){PubHub.pub("View/construct",c);c.activateImmediately&&c.activate()})}$.extend(!0,View.prototype,Strings.prototype,Subscriptions.prototype,Templates.prototype,Tracking.prototype);
View.prototype.destruct=function(){var a=this;return a.deactivate().always(function(){a.isDestructed=!0;a.destroyAllElements();a.unsubscribeAll();_.defer(function(){PubHub.pub("View/destruct",a)})})};
View.prototype.activate=function(a){function b(){d.isActive=!0;d.$view?c():d.build().done(c)}function c(){d.startTrackingSession();$(window).on("blur."+d.id,function(){var a=$.now();$(window).one("focus."+d.id,function(){6E4<$.now()-a&&(d.stopTrackingSession(a),d.startTrackingSession())})});d.$view.addClass("active");a||(d.scrollPosition=0);_.defer(function(){$(window).scrollTop(d.scrollPosition)});PubHub.pub("View/activate",d);e.resolve()}var d=this,e=$.Deferred();d.isActive?e.reject():window.Views?
Views.activate(d,e).done(b).fail(function(){e.reject()}):b();return e.promise()};
View.prototype.deactivate=function(){function a(){b.isActive=!1;b.stopTrackingSession();b.scrollPosition=$(window).scrollTop();$(window).off(b.id);b.$view&&b.$view.removeClass("active");$(".messageBar."+b.id).each(function(){$(this).data("messageBar").close()});PubHub.pub("View/deactivate",b);c.resolve()}var b=this,c=$.Deferred();b.isActive?window.Views?Views.deactivate(b,c).done(a).fail(function(){c.reject()}):a():c.reject();return c.promise()};
View.prototype.setState=function(a){var b=this,c=$.Deferred();b.state!==a&&b.hasState(a)?(b.state=a,c.resolve(),_(function(){PubHub.pub("View/update",b,b.state)}).defer()):c.reject();return c.promise()};View.prototype.hasState=function(a){return _(this.allowedStates).contains(a)};
View.prototype.build=function(){var a=this,b=$.Deferred();$.when(a.buildElement("view"),a.buildElement("footer")).always(function(c,d){c?(c.appendTo("#main"),d&&d.appendTo(c),a.subscribe("keyboard","Keyboard/shortcut",function(b){return a.isActive?!a.handleKeys(b):!0}),a.$actionAlertTarget=c,b.resolve(c,d)):b.reject()});return b.promise()};View.prototype.handleKeys=function(a){return!0};View.prototype.showActionAlert=function(a,b){this.isActive&&this.$view&&this.$view.showActionAlert(a,b)};
function GridView(a,b){var c=this;View.call(c,a,b);$.extend(!0,c,{templates:{view:{options:{hasGrids:!0}}},strings:{updateMessage:VIEW_UPDATE_MESSAGE_DEFAULT,selectionActionAlertLabel:VIEW_ACTIONALERT_LABEL_SELECT},isEmpty:void 0,gridType:null,gridOptions:{respectShowHiddenPref:!1,respectSortOrderPref:!1}},b,{mode:"browse",grids:[]});Procrastination.call(c);TaskQueue.call(c);c.subscribe("gridEmptiness","Grid/markEmpty",function(a,b){_(c.grids).contains(a)&&(c.isActive?c.updateUI():c.checkEmptiness())});
c.subscribe("gridDestruction","Grid/destruct",function(a){a=_(c.grids).indexOf(a);0<=a&&(c.grids.splice(a,1),c.isActive?c.updateUI():c.checkEmptiness())})}$.extend(!0,GridView.prototype,Procrastination.prototype,TaskQueue.prototype,View.prototype);GridView.prototype.build=function(){var a=this;return View.prototype.build.call(a).done(function(){a.setupGrids().always(function(){"selection"===a.mode&&a.executeAllTasks("selectionMode/build")})})};
GridView.prototype.setupGrids=function(){var a=this,b;return(b=Grids.buildNew(a.gridType,[],a.viewOf,a.gridOptions))?(a.grids[0]=b,b.build().done(function(){a.$view.find(".view-grids").prepend(a.grids[0].$grid)})):$.rejected};GridView.prototype.destruct=function(){var a=this;return View.prototype.destruct.call(a).done(function(){_(a.grids).invoke("destruct")})};
GridView.prototype.activate=function(a){var b=this;return View.prototype.activate.call(b,a).done(function(){_(b.grids).each(function(a){"selection"===b.mode&&b.executeAllTasks("selectionMode/activate");a.activate()});b.updateUI()})};GridView.prototype.deactivate=function(){var a=this;return View.prototype.deactivate.call(a).done(function(){_(a.grids).invoke("deactivate");a.executeAllTasks("updates")})};
GridView.prototype.updateUI=function(){var a=this;return a.$view?a.procrastinate("updateUI",function(){a.checkEmptiness()}):$.rejected};GridView.prototype.checkEmptiness=function(){var a=this,b;b=_(a.grids).every(function(a){return a.checkEmptiness()});a.isEmpty!==b&&(a.isEmpty=b,PubHub.pub("View/markEmpty",a,b));a.$view&&(a.$view.toggleClass("empty",a.isEmpty),a.isEmpty?a.$emptyMessage||a.buildElement("emptyMessage").done(function(b){a.$view.append(b)}):a.destroyElement("emptyMessage"));return a.isEmpty};
GridView.prototype.enterSelectionMode=function(a,b){var c=this,d=$.Deferred();"selection"!==c.mode?(c.mode="selection",c.selection=a,c.queueTask("selectionMode/build","getSelectors",function(){c.selectors=_(c.grids).chain().map(function(b){return b.startSelection(a)}).compact().value()}),c.queueTask("selectionMode/activate","setUI",function(){c.setSelectionUI(!0)}),c.isActive&&c.selection.showActionAlert&&c.showActionAlert(c.makeString("selectionActionAlertLabel"),"select"),c.$view&&c.procrastinate("selectionModeSetup",
function(){c.selection===a&&(c.$view&&c.executeAllTasks("selectionMode/build"),c.isActive&&c.executeAllTasks("selectionMode/activate"))}),d.resolve()):(a.reject(),d.reject());return d.promise()};
GridView.prototype.exitSelectionMode=function(){var a=$.Deferred();"selection"===this.mode?(this.mode="browse",delete this.selection,delete this.selectors,this.$view&&(_(this.grids).invoke("endSelection"),this.setSelectionUI(!1)),this.dequeueAllTasks("selectionMode/build"),this.dequeueAllTasks("selectionMode/activate"),a.resolve()):a.reject();return a.promise()};GridView.prototype.setSelectionUI=function(a){this.$view&&this.$view.toggleClass("selectionMode",a)};
function FetcherView(a,b,c){var d=this;GridView.call(d,a,c);$.extend(!0,d,{strings:{updateMessage:function(){return $.mustache(VIEW_UPDATE_MESSAGE_FETCHER,{groupName:this.viewOf.makeString("groupName")})},fetchMessageBusy:function(){return $.mustache(VIEW_FETCH_MESSAGE_BUSY,{itemsName:this.viewOf.makeString("itemsName")})},fetchMessageError:function(){return $.mustache(VIEW_FETCH_MESSAGE_ERROR,{itemsName:this.viewOf.makeString("itemsName")})}},fetchOnScroll:!0,skipSelectionFetching:!1},c);d.viewOf=
b;d.viewOf.fetch&&(d.subscribe("groupFetch","Group/fetch",function(a){a===d.viewOf&&(d.isActive?d.updateUI():d.checkEmptiness())}),d.subscribe("groupReset","Group/reset",function(a){a===d.viewOf&&d.isActive&&d.requestFetch()}))}$.extend(!0,FetcherView.prototype,GridView.prototype);
FetcherView.prototype.activate=function(a){var b=this;return GridView.prototype.activate.call(b,a).done(function(){function a(){var d=$.Deferred(),e=_(b.viewOf.items).every(function(a){return!a.visibility}),f=_(b.grids).every(function(a){return!a.includeHiddenItems});b.viewOf.fetchContinue&&e&&f?b.requestFetch().done(function(){d.follow(a())}).fail(function(){d.reject()}):d.resolve();return d.promise()}b.viewOf.fetch&&("selection"===b.mode?b.requestFetchAll().done(function(){"selection"===b.mode&&
_(function(){b.executeAllTasks("selectionMode/fetch")}).defer()}):b.viewOf.fetchedOnce?a().always(function(){b.toggleFetchOnScroll(!0)}):b.requestFetch().done(function(){a().always(function(){b.toggleFetchOnScroll(!0)})}))})};FetcherView.prototype.deactivate=function(){var a=this;return GridView.prototype.deactivate.call(a).done(function(){a.fetchOnScroll&&a.toggleFetchOnScroll(!1);a.viewOf.isDestructed&&!a.isDestructed&&a.destruct()})};
FetcherView.prototype.updateUI=function(){var a=this;return a.$view?a.procrastinate("updateUI",function(){a.viewOf.fetchedOnce&&a.checkEmptiness();a.$view&&(a.$view.toggleClass("pending",!a.viewOf.fetchedOnce),a.hasFootnoteNavigation&&(a.prevView?a.$view.find(".view-footnote-prev").removeClass("hidden").attr("href","#view="+a.prevView.id).text(a.prevView.makeString("footnoteNavigationTitle")):a.$view.find(".view-footnote-prev").addClass("hidden").text(""),a.nextView?a.$view.find(".view-footnote-next").removeClass("hidden").attr("href",
"#view="+a.nextView.id).text(a.nextView.makeString("footnoteNavigationTitle")):a.$view.find(".view-footnote-next").addClass("hidden").text("")))}):$.rejected};FetcherView.prototype.handleKeys=function(a){var b=!1;2===a.length?a[0].which===KEYCODES.f&&a[1].which===KEYCODES.a&&(this.requestFetchAll(),b=!0):1===a.length&&(a[0].which===KEYCODES.j&&this.prevView?(this.prevView.activate(),b=!0):a[0].which===KEYCODES.k&&this.nextView&&(this.nextView.activate(),b=!0));return b};
FetcherView.prototype.requestFetch=function(a){var b=this;return b.isActive&&b.viewOf&&b.viewOf.fetch&&b.viewOf.fetchContinue?(DiscreetActivity.show(b.id+"/fetch",b.makeString("fetchMessageBusy")),b.viewOf.fetch(a).always(function(){DiscreetActivity.hide(b.id+"/fetch")}).fail(function(a,d){b.isActive&&"abort"!==d&&MessageBars.buildNew(b.makeString("fetchMessageError"),{extraClasses:"alert "+b.id})})):$.rejected};
FetcherView.prototype.requestFetchAll=function(){var a=this,b=$.Deferred();a.isActive&&a.viewOf&&a.viewOf.fetchAll?a.viewOf.fetchContinue?(BlockingActivity.show(a.id+"/fetch",a.makeString("fetchMessageBusy")),b.follow(a.viewOf.fetchAll().always(function(){BlockingActivity.hide(a.id+"/fetch")}).fail(function(b,d){a.isActive&&"abort"!==d&&MessageBars.buildNew(a.makeString("fetchMessageError"),{extraClasses:"alert "+a.id})}))):b.resolve():b.reject();return b.promise()};
FetcherView.prototype.toggleFetchOnScroll=function(a){var b=this;b.fetchOnScroll&&(b.viewOf&&b.viewOf.fetch)&&(a?b.isActive&&b.viewOf.fetchContinue&&b.subscribe("scrollPosition","Viewport/update",function(a){0<a.deltas.top&&("browse"===b.mode&&b.viewOf.fetchContinue&&Viewport.withinYOfBottom(VIEW_FETCH_THRESHOLD))&&(b.toggleFetchOnScroll(!1),b.requestFetch().done(function(){b.viewOf.fetchContinue&&_(function(){b.toggleFetchOnScroll(!0)}).delay(1E3)}))}):b.unsubscribe("scrollPosition"))};
FetcherView.prototype.enterSelectionMode=function(a,b){var c=this,d=$.Deferred();"selection"!==c.mode?!c.isActive||a.skipFetching||c.skipSelectionFetching?d.follow(GridView.prototype.enterSelectionMode.call(c,a,b)):c.requestFetchAll().always(function(){d.follow(GridView.prototype.enterSelectionMode.call(c,a,b)).done(function(){_(function(){c.executeAllTasks("selectionMode/fetch")}).defer()})}):(a.reject(),d.reject());return d.promise()};
FetcherView.prototype.exitSelectionMode=function(){var a=this;return GridView.prototype.exitSelectionMode.call(a).done(function(){a.dequeueAllTasks("selectionMode/fetch")})};FetcherView.prototype.setNextView=function(a){a!==this.nextView&&(this.nextView=a,this.isActive&&this.updateUI())};FetcherView.prototype.setPrevView=function(a){a!==this.prevView&&(this.prevView=a,this.isActive&&this.updateUI())};
function PublicPhotoPageView(a,b){FetcherView.call(this,"photoPage",a,b);$.extend(!0,this,{templates:{view:{options:{extraClasses:"photosView"}},footer:{selector:"#template-footer"},title:{selector:"#template-title",options:{userName:function(){return this.viewOf.userName},title:function(){return this.makeString("title")}}}},strings:{title:function(){return this.viewOf.title},fetchMessageBusy:PHOTOPAGE_FETCH_MESSAGE_BUSY,fetchMessageError:PHOTOPAGE_FETCH_MESSAGE_ERROR},handlePhotoViewer:!0,photoViewerFeatures:{sharing:!1,
infoPanel:!1,jumpToMoment:!1,hide:!1,download:!!a.allowDownload,miscMenu:!1,editTimestamp:!1,rotate:!1,baleet:!1},gridType:1===this.viewOf.items.length?"singlePhoto":"photo",gridOptions:{dropCap:!0,fileByTimestamp:!1,handlePhotoViewer:!1}},b)}$.extend(!0,PublicPhotoPageView.prototype,FetcherView.prototype);
PublicPhotoPageView.prototype.build=function(){var a=this,b=[];b.push(FetcherView.prototype.build.call(a).done(function(b){if(b&&a.handlePhotoViewer)a.$view.on("click",".photoPreview",function(){var b=a.viewOf.itemsDictionary[$(this).data("photo-id")];PhotoViewer.activate(b,a,!0);return!1})}));b.push(a.buildElement("title").done(function(a){$("#top-right").after(a)}));return $.when.apply(a,b).promise()};PublicPhotoPageView.prototype.destruct=function(){return $.rejected};
PublicPhotoPageView.prototype.selectItemForViewer=function(a,b){return this.viewOf.selectItemForViewer(a,b)};
var Grids=function(){return{buildNew:function(a){var b=_(arguments).rest(1),c=null;switch(a){case "context":c=Object.create(ContextGrid.prototype);c=ContextGrid.apply(c,b)||c;break;case "photo":c=Object.create(PhotoGrid.prototype);c=PhotoGrid.apply(c,b)||c;break;case "singlePhoto":c=Object.create(SinglePhotoGrid.prototype);c=SinglePhotoGrid.apply(c,b)||c;break;case "semantic":c=Object.create(SemanticGrid.prototype);c=SemanticGrid.apply(c,b)||c;break;case "today":c=Object.create(TodayGrid.prototype),
c=TodayGrid.apply(c,b)||c}return c}}}(),MessageBars=function(){return{buildNew:function(a,b){return new MessageBar(a,b)}}}(),Downloader=function(){var a;$(function(){a=$("<iframe/>",{id:"downloader"}).appendTo("body")});return{get:function(b){Initializer.ready(function(){a&&(a.removeAttr("src"),a.attr("src",b));PubHub.pub("Downloader/get",b)})}}}(),Thumbnails=function(){var a={};$.extend(!0,a,Procrastination.prototype);$.extend(!0,a,{hosts:{},finishedDownloadSrcs:[],finishedDownloadImages:[],concurrentDownloads:12});
Procrastination.call(a);a.queueDownload=function(a){var c=this,d=$.Deferred(),e=_(c.finishedDownloadSrcs).indexOf(a),f;0<=e?d.resolve(c.finishedDownloadImages[e]):a?(e=document.createElement("a"),e.href=a,f=e.hostname,c.hosts[f]||(c.hosts[f]={isDownloading:!1,imageSrcs:[],imageDfds:[]}),c.hosts[f].imageSrcs.push(a),c.hosts[f].imageDfds.push(d),c.hosts[f].isDownloading||c.procrastinate("download:"+f,function(){c.startDownloading(f)})):d.reject(1,"No thumbnailURL provided");return d.promise()};a.dequeueDownload=
function(a){var c;a&&(c=document.createElement("a"),c.href=a,c=c.hostname,this.hosts[c]&&(a=_(this.hosts[c].imageSrcs).indexOf(a),0<=a&&(this.hosts[c].imageSrcs.splice(a,1),this.hosts[c].imageDfds.splice(a,1)[0].reject(2,"Download canceled"))))};a.startDownloading=function(a){function c(a){var b,c;a<f.imageSrcs.length?(b=f.imageSrcs.splice(a,1)[0],c=f.imageDfds.splice(a,1)[0],$("<img/>",{load:function(){e.finishedDownloadSrcs.push(b);e.finishedDownloadImages.push(this);c.resolve(this)},error:function(){c.reject(3,
"Error downloading image")},src:b})):c=$.rejected;return c.promise()}function d(a){f.isDownloading&&(f.imageSrcs.length?c(a).always(function(){d(0)}):f.isDownloading=!1)}var e=this,f;a?e.hosts[a]&&!e.hosts[a].isDownloading&&(f=e.hosts[a],f.isDownloading=!0,_.times(e.concurrentDownloads||e.imageSrcs.length,function(){d(0)})):_(e.hosts).each(function(a,b){e.startDownloading(b)})};a.pauseDownloading=function(a){var c=this;a?c.hosts[a]&&c.hosts[a].isDownloading&&(c.hosts[a].isDownloading=!1):_(c.hosts).each(function(a,
b){c.startDownloading(b)})};a.generateURL=function(a,c){var d;void 0===this.allowRetina&&(this.allowRetina=2<=window.devicePixelRatio);void 0===this.allowWebP&&(this.allowWebP=Modernizr.webp&&!!window.Preferences&&!!Preferences.get("webp"));this.allowRetina&&1024<parseInt(c)&&(c="1024"+c.split("").splice(-1,1)[0]);d=THUMBNAIL_SERVER_URL+a+"/"+c;this.allowWebP&&"original"!==c&&(d+="~webp");this.allowRetina&&"original"!==c&&(d+="@2x");return d};PubHub.sub("Preference/set",function(b,c){"webp"===b&&
(a.allowWebP=Modernizr.webp&&!!c)});return a}(),PhotoViewer=function(){var a={};$.extend(!0,a,Procrastination.prototype,Strings.prototype,Subscriptions.prototype,TaskQueue.prototype,Templates.prototype,Tracking.prototype);$.extend(!0,a,{supplier:null,photo:null,nextPhoto:null,prevPhoto:null,infoPanelIsOpen:null,defaultFeatures:{navigation:!0,sharing:!1,slideshow:!0,infoPanel:!0,nearbyPhotos:!0,jumpToMoment:!0,hide:!1,miscMenu:!0,editTimestamp:!1,rotate:!1,download:"iOS"!==Platform.os,baleet:!1},features:{},
templates:{shareMenu:{selector:"#template-shareMenu",options:{title:SHAREMENU_TITLE_SINGULAR,hasPath:!0}}},strings:{sharePhotoMailSubject:function(){return $.mustache(PHOTOVIEWER_SHARE_PHOTOMAIL_SUBJECT,{date:this.photo.timestamp?this.photo.timestamp.toString(PHOTOVIEWER_SHARE_PHOTOMAIL_DATE_FORMAT):!1})},sharePhotoPageTitle:function(){return $.mustache(PHOTOVIEWER_SHARE_PHOTOPAGE_TITLE,{date:this.photo.timestamp?this.photo.timestamp.toString(PHOTOVIEWER_SHARE_PHOTOPAGE_DATE_FORMAT):!1})}},isActive:!1,
isSettingPhoto:!1,mode:"browse",previewSize:_(THUMBNAIL_FULL_SIZES).chain().values().first().value(),pendingRotation:null});Procrastination.call(a);Strings.call(a);Subscriptions.call(a);TaskQueue.call(a);Templates.call(a);Tracking.call(a);a.activate=function(a,c,d){var e=this,f=$.Deferred();!e.isActive&&e.$photoViewer?(e.isActive=!0,e.checkPreviewSize(),c&&e.setSupplier(c),a&&e.setPhoto(a),e.popover.open(d).always(function(){e.subscribe("viewportResize","Viewport/update",function(a){e.checkPreviewSize()&&
0<a.deltas.width&&e.loadPhoto(!0);a=e.$infoPanel.find(".photo-info");a.length&&a.data("scrollPane")&&a.scrollPane().update()});$(document).on("keyup.photoViewer",function(a){switch(a.which){case KEYCODES.right:e.goToNextPhoto();e.hideChrome();break;case KEYCODES.left:e.goToPrevPhoto();e.hideChrome();break;case KEYCODES.esc:"slideshow"===e.mode?e.pauseSlideshow():e.deactivate(!0)}});e.$photoViewer.on("mousemove touchstart click",function(a){"slideshow"!==e.mode&&e.showChrome();e.navArrowTimeout&&clearTimeout(e.navArrowTimeout);
e.navArrowTimeout=setTimeout(function(){e.hideChrome()},PHOTOVIEWER_HIDECHROME_WAIT)});e.navArrowTimeout=setTimeout(function(){e.hideChrome()},PHOTOVIEWER_HIDECHROME_WAIT);e.startTrackingSession();$(window).on("blur.photoViewer",function(){var a=$.now();$(window).one("focus.photoViewer",function(){6E4<$.now()-a&&(e.stopTrackingSession(a),e.startTrackingSession())})});"slideshow"===e.mode&&e.executeAllTasks("slideshowMode/activate");PubHub.pub("PhotoViewer/activate");f.resolve()})):f.reject();return f.promise()};
a.deactivate=function(a){var c=this,d=$.Deferred();c.isActive?(c.isActive=!1,c.popover.close(a).always(function(){c.unsubscribe("viewportResize");c.stopTrackingSession();$(document,window).off(".photoViewer");c.$photoViewer.find(".photoViewer-messageBars").find(".messageBar").each(function(){$(this).data("messageBar").close()});c.clearPhoto();c.pauseSlideshow(!0);c.$photoViewer.find(".bubble").each(function(){$(this).bubble().close()});c.applyPendingPhotoRotation();c.$photoViewer.off("mousemove touchstart");
PubHub.pub("PhotoViewer/deactivate");d.resolve()})):d.reject();return d.promise()};a.setSupplier=function(a){a!==this.supplier&&(this.supplier=a||null,"selection"!==this.mode&&this.setFeatures($.extend({},this.defaultFeatures,a?a.photoViewerFeatures:void 0)))};a.setFeatures=function(a){var c=this.features.infoPanel;this.applyPendingPhotoRotation();$.extend(!0,this.features,a);a=_(this.features).chain().map(function(a,b){return a?b:!1}).compact().value().join(" ");this.$photoViewer&&(this.$photoViewer.attr("data-features",
a),this.isActive&&c!==this.features.infoPanel&&(this.features.infoPanel?this.getCurrentPhotoMeta():this.hideInfoPanel()))};a.setPhoto=function(a,c,d){var e=this;if(e.isSettingPhoto)return $.rejected;e.isSettingPhoto=!0;e.photoActivity.show("settingPhoto");return e.getPhotoFromSupplier(a,c).done(function(a,b){if(d||a!==e.photo)e.applyPendingPhotoRotation(),e.photo=a,e.nextPhoto=b,e.setFeatures({navigation:!!e.nextPhoto&&$.extend({},e.defaultFeatures,e.supplier.photoViewerFeatures).navigation,slideshow:"selection"!==
e.mode&&!!e.nextPhoto&&$.extend({},e.defaultFeatures,e.supplier.photoViewerFeatures).slideshow}),e.$photoViewer.find(".photoViewer-photos .photoHolder").empty().append($("<img/>")),e.loadPhoto().done(function(){a===e.photo&&e.nextPhoto&&e.nextPhoto.loadLarge(e.previewSize)}),a.timestamp?e.$photoViewer.find(".photoViewer-jumpToMoment").removeClass("hidden").text(a.timestamp.toString(PHOTOVIEWER_JUMPTO_DATE_FORMAT)):e.$photoViewer.find(".photoViewer-jumpToMoment").addClass("hidden"),e.features.infoPanel&&
e.infoPanelIsOpen&&e.getCurrentPhotoMeta(),PubHub.pub("PhotoViewer/changePhoto",e,a)}).always(function(){e.isSettingPhoto=!1;e.photoActivity.hide("settingPhoto")})};a.clearPhoto=function(){this.applyPendingPhotoRotation();this.prevPhoto=this.nextPhoto=this.photo=null;this.$photoViewer.find(".photoViewer-photos .photoHolder").empty();this.clearInfoPanel()};a.getPhotoFromSupplier=function(a,c){var d=$.Deferred();this.supplier&&this.supplier.selectItemForViewer?d.follow(this.supplier.selectItemForViewer(a,
c)):d.reject();return d.promise()};a.goToNextPhoto=function(a){var c=this,d=$.Deferred();c.pauseSlideshow();c.features.navigation&&c.nextPhoto?d.follow(c.setPhoto(c.nextPhoto).done(function(d,f,g,k){k&&!a&&c.showActionAlert(PHOTOVIEWER_ACTIONALERT_LABEL_ATEND,"end")})):d.reject();return d.promise()};a.goToPrevPhoto=function(a){var c=this,d=$.Deferred();c.pauseSlideshow();c.features.navigation&&c.photo?d.follow(c.setPhoto(c.photo,-1).done(function(d,f,g,k){g&&!a&&c.showActionAlert(PHOTOVIEWER_ACTIONALERT_LABEL_ATSTART,
"start")})):d.reject();return d.promise()};a.loadPhoto=function(a){var c=this,d=c.photo,e=c.$photoViewer.find(".photoViewer-photos"),f=e.find(".photoHolder > img"),g=$.Deferred();c.photoActivity.show("loadPhoto-"+d.id);c.applyPendingPhotoRotation().always(function(){d===c.photo?(a||(e.height()?f.attr({src:Thumbnails.generateURL(d.thumbnailID,THUMBNAIL_SIZE_PHOTOPREVIEW),width:Math.min(c.previewSize,d.width,e.height()*d.aspectRatio,c.previewSize*d.aspectRatio)}):_(function(){d===c.photo&&"resolved"!==
g.state()&&f.attr({src:Thumbnails.generateURL(d.thumbnailID,THUMBNAIL_SIZE_PHOTOPREVIEW),width:Math.min(c.previewSize,d.width,e.height()*d.aspectRatio,c.previewSize*d.aspectRatio)})}).defer()),g.follow(d.loadLarge(c.previewSize)).done(function(a){d===c.photo&&(f.attr("src",a),"Internet Explorer"===Platform.browser?f.removeAttr("width"):setTimeout(function(){f.removeAttr("width")},2E3))}).fail(function(){d===c.photo&&MessageBars.buildNew(PHOTOVIEWER_MESSAGE_LOAD_ERROR,{extraClasses:"alert",insertElement:c.$messageBars})})):
g.reject()});return g.promise().always(function(){c.photoActivity.hide("loadPhoto-"+d.id)})};a.showInfoPanel=function(){var a=$.Deferred();this.features.infoPanel&&!this.infoPanelIsOpen?(this.infoPanelIsOpen=!0,this.$photoViewer.addClass("infoPanel-open"),Cookie.setRemote("photoMeta",!0),this.isActive&&this.getCurrentPhotoMeta(),a.resolve()):a.reject();return a.promise()};a.hideInfoPanel=function(){var a=$.Deferred();this.features.infoPanel&&this.infoPanelIsOpen?(this.infoPanelIsOpen=!1,this.applyPendingPhotoRotation(),
this.$photoViewer.removeClass("infoPanel-open"),this.$infoPanel.find(".photoViewer-miscMenu").bubble().close(),Cookie.setRemote("photoMeta",!1),a.follow(this.clearInfoPanel())):a.reject();return a.promise()};a.clearInfoPanel=function(){var a=$.Deferred(),c=this.$infoPanel.find(".photo-info");c.length?(c.removeClass("active"),c.find(".bubble").each(function(){$(this).bubble().destruct()}),_(function(){c.length&&(c.scrollPane()instanceof ScrollPane&&c.scrollPane().destruct(),c.empty().remove());a.resolve()}).delay(c.transitionDuration())):
a.resolve();return a.promise()};a.getCurrentPhotoMeta=function(){var a=this,c=$.Deferred();thPhoto=a.photo;a.isActive&&a.features.infoPanel&&a.infoPanelIsOpen&&thPhoto?a.clearInfoPanel().done(function(){a.infoSpinner.show();thPhoto.getDetails().done(function(d){var e;thPhoto===a.photo?(a.infoSpinner.hide().always(function(){e=$("#template-photo-info").mustache($.extend({pid:thPhoto.id,pluralSources:1!==d.sources.length,hasNearbyPhotos:a.features.nearbyPhotos&&!!d.nearbyPhotos&&d.nearbyPhotos.length,
hasDevice:!!d.camera||!!d.lens,hasEXIF:!$.isEmptyObject(d.exif),hasTimestamp:!!thPhoto.timestamp,absoluteDate:thPhoto.timestamp?thPhoto.timestamp.toString(PHOTOVIEWER_META_DATE_FORMAT):PHOTO_UNDATED_TITLE,relativeDate:thPhoto.timestamp?thPhoto.timestamp.toString("dddd, ")+thPhoto.timestamp.relativeToNow():!1},d)).appendTo(a.$infoPanel.find(".photoViewer-infoPanel-content"));a.features.nearbyPhotos&&(d.nearbyPhotos&&d.nearbyPhotos.length)&&_(d.nearbyPhotos).chain().first(6).each(function(c){var d=
c.photo,k=$("<span/>",{"class":"photo-info-nearby-thumbnail",title:$.mustache(PHOTOVIEWER_NEARBY_DISTANCE_LABEL,{units:1E3<c.distance?"kilometers":"meters",distance:1E3<c.distance?(c.distance/1E3).toFixed(1):Math.round(c.distance)})}).appendTo(e.find(".photo-info-nearby-thumbnails")),l=Thumbnails.generateURL(d.thumbnailID,THUMBNAIL_SIZE_TINY);$("<img/>",{load:function(){$(this).off("load");k.css("backgroundImage","url('"+l+"')")},src:l});k.on("click",function(){a.jumpToMoment(d,!0)})});e.scrollPane({isActive:!0});
_(function(){e.addClass("active")}).defer();e.find(".photo-info-date-absolute").on("click",function(){a.jumpToMoment(thPhoto)});e.find(".photo-info-semantic-tag, .photo-info-semantic-info").each(function(){var a=$(this),b;b=a.find(".bubble").bubble({closeAfter:0,clickToClose:!1,clickOutsideToClose:!1});a.on({mouseenter:function(){b.open()},mouseleave:function(){b.close()}})});a.$photoViewer.find(".photoViewer-miscMenu-hide, .photoViewer-infoPanel-hide").toggleClass("visible",!!thPhoto.visibility);
a.$photoViewer.find(".photoViewer-miscMenu-unhide, .photoViewer-infoPanel-unhide").toggleClass("visible",!thPhoto.visibility)}),a.getPhotoFromSupplier(a.photo,1).done(function(a){a.getDetails()}),c.resolve()):c.reject()}).fail(function(){a.infoSpinner.hide();c.reject();MessageBars.buildNew(PHOTOVIEWER_MESSAGE_DETAILS_ERROR,{extraClasses:"alert",insertElement:a.$messageBars})})}):c.reject();return c.promise()};a.applyPendingPhotoRotation=function(){var a=[];if(this.features.rotate){this.abortProcrastinatedTasks("applyRotation");
if(this.pendingRotation){for(;0<this.pendingRotation;this.pendingRotation--)a.push(this.photo.rotateClockwise());for(;0>this.pendingRotation;this.pendingRotation++)a.push(this.photo.rotateCounterClockwise())}return $.when.apply(this,a)}return $.rejected};a.clearRotation=function(){this.pendingRotation=0;this.$photoViewer.find(".photoHolder > img").removeClass("rotation-1 rotation-2 rotation-3").css({"max-width":"100%","max-height":"100%"})};a.showChrome=function(){this.$photoViewer.removeClass("hideChrome")};
a.hideChrome=function(){this.$photoViewer.addClass("hideChrome");this.$photoViewer.find(".bubble").each(function(){$(this).bubble().close()})};a.startSlideshow=function(){function a(){c.nextPhoto?c.getPhotoFromSupplier(c.nextPhoto,0).done(function(d,e,f,g){f?c.slideshowTimeout=setTimeout(function(){c.pauseSlideshow(!0);c.showActionAlert(PHOTOVIEWER_ACTIONALERT_LABEL_THEEND,"end")},PHOTOVIEWER_SLIDESHOW_WAIT):(c.nextPhoto.loadLarge(c.previewSize),c.slideshowTimeout=setTimeout(function(){c.setPhoto(c.nextPhoto).done(a).fail(function(){c.pauseSlideshow();
MessageBars.buildNew(PHOTOVIEWER_MESSAGE_SLIDESHOW_ERROR,{insertElement:c.$messageBars})})},PHOTOVIEWER_SLIDESHOW_WAIT))}).fail(function(){c.pauseSlideshow();MessageBars.buildNew(PHOTOVIEWER_MESSAGE_SLIDESHOW_ERROR,{insertElement:c.$messageBars})}):(c.pauseSlideshow(),MessageBars.buildNew(PHOTOVIEWER_MESSAGE_SLIDESHOW_ERROR,{insertElement:c.$messageBars}))}var c=this;c.features.slideshow&&"slideshow"!==c.mode&&(c.mode="slideshow",c.hideChrome(),c.hideInfoPanel(),c.queueTask("slideshowMode/activate",
"startLoop",function(){c.showActionAlert(PHOTOVIEWER_ACTIONALERT_LABEL_SLIDESHOW,"slideshow");a()}),c.isActive&&c.executeAllTasks("slideshowMode/activate"))};a.pauseSlideshow=function(a){"slideshow"===this.mode&&(this.mode="browse",clearTimeout(this.slideshowTimeout),this.slideshowTimeout=null,this.dequeueAllTasks("slideshowMode/activate"),a||this.showActionAlert(PHOTOVIEWER_ACTIONALERT_LABEL_PAUSE,"pause"))};a.checkPreviewSize=function(){var a,c=_(THUMBNAIL_FULL_SIZES).keys(),d=Viewport.getWidth();
(a=_(c).find(function(a){return d<=a}))||(a=_(c).last());return a!==this.previewSize?(this.previewSize=a,!0):!1};a.enterSelectionMode=function(){"selection"!==this.mode&&(this.mode="selection",this.$photoViewer.addClass("selectionMode"),this.setFeatures({sharing:!1,slideshow:!1,infoPanel:!1,nearbyPhotos:!1,jumpToMoment:!1,hide:!1,miscMenu:!1,editTimestamp:!1,rotate:!1,download:!1,baleet:!1}))};a.exitSelectionMode=function(){"selection"===this.mode&&(this.mode="browse",this.$photoViewer.removeClass("selectionMode"),
this.setFeatures($.extend({},this.defaultFeatures,this.supplier?this.supplier.photoViewerFeatures:void 0)))};a.rotatePhotoRight=function(){var a=this,c=$.Deferred(),d,e,f=!1;a.features.rotate?(a.showActionAlert(PHOTOVIEWER_ACTIONALERT_LABEL_ROTATERIGHT,"rotateRight"),d=a.$photoViewer.find(".photoViewer-photos"),e=d.find(".photoHolder > img"),e.hasClass("rotation-1")?e.removeClass("rotation-1").addClass("rotation-2"):e.hasClass("rotation-2")?(e.removeClass("rotation-2").addClass("rotation-3"),f=!0):
e.hasClass("rotation-3")?e.removeClass("rotation-3"):(e.addClass("rotation-1"),f=!0),f?e.css({"max-width":d.height(),"max-height":d.width()}):e.css({"max-width":"100%","max-height":"100%"}),a.pendingRotation++,a.procrastinate("applyRotation",function(){a.applyPendingPhotoRotation()},null,PHOTO_ROTATION_REQUEST_WAIT),c.resolve()):c.reject();return c.promise()};a.rotatePhotoLeft=function(){var a=this,c=$.Deferred(),d,e,f=!1;a.features.rotate?(a.showActionAlert(PHOTOVIEWER_ACTIONALERT_LABEL_ROTATELEFT,
"rotateLeft"),d=a.$photoViewer.find(".photoViewer-photos"),e=d.find(".photoHolder > img"),e.hasClass("rotation-3")?e.removeClass("rotation-3").addClass("rotation-2"):e.hasClass("rotation-2")?(e.removeClass("rotation-2").addClass("rotation-1"),f=!0):e.hasClass("rotation-1")?e.removeClass("rotation-1"):(e.addClass("rotation-3"),f=!0),f?e.css({"max-width":d.height(),"max-height":d.width()}):e.css({"max-width":"100%","max-height":"100%"}),a.pendingRotation--,a.procrastinate("applyRotation",function(){a.applyPendingPhotoRotation()},
null,PHOTO_ROTATION_REQUEST_WAIT),c.resolve()):c.reject();return c.promise()};a.hidePhoto=function(){var a=$.Deferred();this.features.hide?(this.showActionAlert(PHOTOVIEWER_ACTIONALERT_LABEL_HIDE,"hide"),a.follow(this.photo.hide())):a.reject();return a.promise()};a.unhidePhoto=function(){var a=$.Deferred();this.features.hide?(this.showActionAlert(PHOTOVIEWER_ACTIONALERT_LABEL_UNHIDE,"unhide"),a.follow(this.photo.unhide())):a.reject();return a.promise()};a.downloadPhoto=function(){var a=this,c=$.Deferred();
a.features.download?a.applyPendingPhotoRotation().always(function(){a.photo.download();c.resolve()}):c.reject();return c.promise()};a.deletePhoto=function(){var a=this,c=$.Deferred();a.features.baleet?a.photo.baleet().done(function(){a.nextPhoto?(a.popover.open(),a.goToNextPhoto(),MessageBars.buildNew(PHOTOVIEWER_MESSAGE_DELETE_SUCCESS,{insertElement:a.$messageBars})):a.deactivate();c.resolve()}).fail(function(d){a.popover.open();d&&MessageBars.buildNew(PHOTOVIEWER_MESSAGE_DELETE_ERROR,{extraClasses:"alert",
insertElement:a.$messageBars});c.reject()}):c.reject();return c.promise()};a.editPhotoTimestamp=function(){var a=this,c=$.Deferred();a.features.editTimestamp?a.photo.editTimestamp().always(function(){a.popover.open();c.resolve()}).done(function(){MessageBars.buildNew($.mustache(PHOTOVIEWER_MESSAGE_EDITTIMESTAMP_SUCCESS,{timestamp:a.photo.timestamp.toString(PHOTOVIEWER_META_DATE_FORMAT)}),{insertElement:a.$messageBars})}):c.reject();return c.promise()};a.jumpToMoment=function(a,c){var d=this,e=$.Deferred(),
f=a||d.photo;d.features.jumpToMoment||c?e.follow(Moments.jumpTo(f.id).done(function(){d.deactivate(!0)}).fail(function(){MessageBars.buildNew(MOMENT_JUMPTO_MESSAGE_ERROR,{extraClasses:"alert",insertElement:d.$messageBars})})):e.reject();return e.promise()};a.sharePhotoTo=function(a,c){var d=this,e=d.photo,f=d.supplier;d.isActive&&d.features.sharing&&c.done(function(a){d.isActive?d.popover.open():d.activate(e,f);a&&MessageBars.buildNew(a,{insertElement:d.$messageBars})}).fail(function(a,b){b?d.deactivate():
(d.isActive?d.popover.open():d.activate(e,f),a&&MessageBars.buildNew(a,{extraClasses:"alert",insertElement:d.$messageBars}))})};a.handleKeys=function(a){var c=!1;2===a.length?a[0].which===KEYCODES.r&&a[1].which===KEYCODES.r&&this.features.rotate?(this.rotatePhotoRight(),c=!0):a[0].which===KEYCODES.r&&(a[1].which===KEYCODES.l&&this.features.rotate)&&(this.rotatePhotoLeft(),c=!0):1===a.length&&(a[0].which===KEYCODES.i&&this.features.infoPanel?(this.infoPanelIsOpen?this.hideInfoPanel():this.showInfoPanel(),
c=!0):a[0].which===KEYCODES.h&&this.features.hide?(this.photo.visibility?this.hidePhoto():this.unhidePhoto(),c=!0):a[0].which===KEYCODES.k&&this.features.navigation?(this.goToNextPhoto(),c=!0):a[0].which===KEYCODES.j&&this.features.navigation?(this.goToPrevPhoto(),c=!0):a[0].which===KEYCODES.space&&this.features.slideshow&&("slideshow"===this.mode?this.pauseSlideshow():this.startSlideshow(),c=!0));return c};a.showActionAlert=function(a,c){this.isActive&&this.$actionAlerts&&this.$actionAlerts.showActionAlert(a,
c)};a.subscribe("photoLoad","Photo/loadLarge",function(b,c){var d;a.isActive&&b===a.photo&&(d=a.$photoViewer.find(".photoViewer-photos .photoHolder > img"),d.attr("src")!==c&&a.loadPhoto(!0))});a.subscribe("photoRotate","Photo/set/orientation",function(b){a.isActive&&b===a.photo&&a.photo.loadLarge(a.previewSize).done(function(){a.clearRotation()})});a.subscribe("photoSetTimestamp","Photo/set/timestamp",function(b,c){a.isActive&&b===a.photo&&(c?(a.$infoPanel.find(".photo-info-date-absolute").html(c.toString(PHOTOVIEWER_META_DATE_FORMAT)),
a.$infoPanel.find(".photo-info-date-relative").show().html(c.toString("dddd, ")+c.relativeToNow())):(a.$infoPanel.find(".photo-info-date-absolute").html(PHOTO_UNDATED_TITLE),a.$infoPanel.find(".photo-info-date-relative").hide()))});a.subscribe("photoHide","Photo/set/visibility",function(b,c){a.isActive&&b===a.photo&&(a.$photoViewer.find(".photoViewer-miscMenu-hide, .photoViewer-infoPanel-hide").toggleClass("visible",!!c),a.$photoViewer.find(".photoViewer-miscMenu-unhide, .photoViewer-infoPanel-unhide").toggleClass("visible",
!c))});a.subscribe("keyboard","Keyboard/shortcut",function(b){return a.isActive?!a.handleKeys(b):!0},1);Initializer.ready(function(){var b,c;a.$photoViewer=$("#photoViewer");a.setFeatures(a.defaultFeatures);a.popover=a.$photoViewer.on({"beforeClose.popover":function(b){b.userTriggered&&a.deactivate()}}).popover({closeButton:!1,autoCenter:!1,clickOutsideToClose:!1,pressEscToClose:!1});a.$messageBars=a.$photoViewer.find(".photoViewer-messageBars");a.$actionAlerts=a.$photoViewer.find(".photoViewer-actionAlerts");
a.photoActivity=new ActivityIndicator("#photoViewer-activity",{showAfter:500});a.$photoViewer.find(".photoViewer-topBars-left, .photoViewer-topBars-right").on("click",function(a){a.stopPropagation()});a.$photoViewer.on("click",function(){"slideshow"===a.mode?a.pauseSlideshow():a.deactivate(!0)});a.$photoViewer.find(".photoViewer-close").on("click",function(){a.deactivate(!0)});a.$photoViewer.find(".photoViewer-next").on("click",function(b){b.stopPropagation();a.navArrowTimeout&&clearTimeout(a.navArrowTimeout);
a.showChrome();a.goToNextPhoto()});a.$photoViewer.find(".photoViewer-prev").on("click",function(b){b.stopPropagation();a.navArrowTimeout&&clearTimeout(a.navArrowTimeout);a.showChrome();a.goToPrevPhoto()});a.$photoViewer.find(".photoViewer-photos").on("click",".photoHolder > img",function(b){b.stopPropagation();"slideshow"===a.mode?a.pauseSlideshow():a.goToNextPhoto()});a.$photoViewer.find(".photoViewer-jumpToMoment").on("click",function(){a.jumpToMoment()});a.buildElement("shareMenu").done(function(b){var c=
a.$photoViewer.find(".photoViewer-share");a.shareMenu=b.bubble({id:"shareMenu-photoViewer"});b.insertAfter(c);c.on({mousedown:function(){return!a.shareMenu.isOpen},click:function(b){$(this).hasClass("disabled")||(a.shareMenu.isOpen?a.shareMenu.close():a.shareMenu.open());return!1}});b.find(".bubbleMenu-button").on("click",function(){Sharing.shareFromPhotoViewer($(this).data("service"))})});a.$photoViewer.find(".photoViewer-info").on("click",function(){a.showInfoPanel()});a.$photoViewer.find(".photoViewer-download").on("click",
function(){a.downloadPhoto()});a.$photoViewer.find(".photoViewer-slideshow").on("click",function(){a.startSlideshow()});a.$infoPanel=a.$photoViewer.find(".photoViewer-infoPanel").on("click",function(a){a.stopPropagation()});a.infoSpinner=a.$infoPanel.find(".spinner").spinner();a.$infoPanel.find(".photoViewer-infoPanel-close").on("click",function(){a.hideInfoPanel()});c=a.$photoViewer.find(".photoViewer-topBars .photoViewer-miscMenu").bubble({id:"photoViewer-topBarMiscMenu"});a.$photoViewer.find(".photoViewer-more").on({mousedown:function(){return!1},
click:function(){c.isOpen?c.close():c.open();return!1}});b=a.$infoPanel.find(".photoViewer-miscMenu").bubble({id:"photoViewer-infoPanelMiscMenu"});a.$infoPanel.find(".photoViewer-infoPanel-more").on({mousedown:function(){return!1},click:function(){b.isOpen?b.close():b.open();return!1}});a.$photoViewer.find(".photoViewer-miscMenu-hide, .photoViewer-infoPanel-hide").on("click",function(){a.hidePhoto()});a.$photoViewer.find(".photoViewer-miscMenu-unhide, .photoViewer-infoPanel-unhide").on("click",function(){a.unhidePhoto()});
a.$photoViewer.find(".photoViewer-miscMenu-rotateRight, .photoViewer-infoPanel-rotateRight").on("click",function(){a.rotatePhotoRight();return!1});a.$photoViewer.find(".photoViewer-miscMenu-rotateLeft, .photoViewer-infoPanel-rotateLeft").on("click",function(){a.rotatePhotoLeft();return!1});a.$photoViewer.find(".photoViewer-miscMenu-editTimestamp, .photoViewer-infoPanel-editTimestamp").on("click",function(){a.editPhotoTimestamp()});a.$photoViewer.find(".photoViewer-miscMenu-download, .photoViewer-infoPanel-download").on("click",
function(){a.downloadPhoto()});a.$photoViewer.find(".photoViewer-miscMenu-delete, .photoViewer-infoPanel-delete").on("click",function(){a.deletePhoto()});User.ready(function(){!1!==Cookie.getRemote("photoMeta")?a.showInfoPanel():a.infoPanelIsOpen=!1})});return a}(),Popovers=function(){var a={currentPopover:null,nextPopover:null,allPopovers:{},get:function(a){return a?this.allPopovers[a]:$.extend({},this.allPopovers)},getOpen:function(){return this.currentPopover},open:function(a,c){var d=this,e=$.Deferred();
Initializer.ready(function(){d.currentPopover?a!==d.currentPopover?(d.nextPopover=a,d.currentPopover.close().always(function(){d.nextPopover=void 0;d.currentPopover=a;e.resolve()})):e.reject():(d.currentPopover=a,e.resolve())});return e.promise()},close:function(a,c){var d=this,e=$.Deferred();d.currentPopover===a?(c.always(function(){d.currentPopover===a&&(d.currentPopover=void 0)}),e.resolve()):e.reject();return e.promise()}};PubHub.sub("Popover/construct",function(b){a.allPopovers[b.id]=b});PubHub.sub("Popover/destruct",
function(b){delete a.allPopovers[b.id]});return a}(),Previews=function(){function a(a){return a?b[a]:$.extend({},b)}var b={};PubHub.sub("Preview/destruct",function(c){a(c.id)&&delete b[c.id]});PubHub.sub("Preference/set",function(b,d){"webp"===b&&_(a()).invoke("build")});return{get:a,buildNew:function(c,d,e,f){var g=a(c);if(!b[c]){switch(e){case "photo":g=new PhotoPreview(c,d,f);break;case "context":g=new ContextPreview(c,d,f);break;case "message":g=new MessagePreview(c,d,f);break;case "semanticPhoto":g=
new SemanticPhotoPreview(c,d,f);break;case "singlePhoto":g=new SinglePhotoPreview(c,d,f);break;default:g=new Preview(c,d,f)}b[c]=g}return g}}}();function BubbleMenu(a,b){var c=this;$.extend(c,{isOpen:!1,selector:"#"+a},b,{id:a});PubHub.pub("BubbleMenu/construct",c);_.defer(function(){c.build().done(function(){Bubble.call(c,c.$el)})})}$.extend(!0,BubbleMenu.prototype,Bubble.prototype);
BubbleMenu.prototype.open=function(a){var b=this,c=$.Deferred();b.isOpen?c.reject():b.build().done(function(){c.follow(Bubble.prototype.open.call(b,a).done(function(){PubHub.pub("BubbleMenu/open",b)}))}).fail(function(){c.reject()});return c.promise()};BubbleMenu.prototype.close=function(a){var b=this;return Bubble.prototype.close.call(b,a).done(function(){PubHub.pub("BubbleMenu/close",b)})};
BubbleMenu.prototype.build=function(){var a=this;a.buildDfd||(a.buildDfd=$.Deferred(),$(function(){a.$el=$(a.selector);a.buildDfd.resolve()}));return a.buildDfd};
var DownloadMenu=function(){var a={};$.extend(!0,a,BubbleMenu.prototype);BubbleMenu.call(a,"downloadMenu");a.build=function(){var a=this;return a.buildDfd?a.buildDfd:BubbleMenu.prototype.build.call(a).done(function(){a.$el.find(".bubbleMenu-button[data-function='download']").on("click",function(){PhotoPage.download()});a.$el.find(".bubbleMenu-button[data-function='copyToCollection']").on("click",function(){PhotoPage.saveToCollection()})})};$(function(){$("#downloadButton").on({mousedown:function(){return!a.isOpen},
click:function(b){PhotoPage.allowDownload&&(a.isOpen?a.close():a.open());return!1}})});return a}(),PhotoPage,PhotoPageView;
(function(){function a(a){$(function(){"unsupported"===a?$("#template-unsupported").mustache({}).appendTo("#main"):503===a||"error"===a||"timeout"===a?$("#template-offline").mustache({}).appendTo("#main"):$("#template-noPhotos").mustache({}).appendTo("#main")})}var b=$.Deferred();$(function(){Initializer.on(b)});Query.id?$.support.cors?(BlockingActivity.show("public.html-load",PHOTOPAGE_FETCH_MESSAGE_BUSY),b.always(function(){BlockingActivity.hide("public.html-load")}).done(function(){PhotoPageView.activate()}).fail(a),
AppStatus.check().done(function(){API.request("publicPhotoPageInfo",{sid:Query.id}).done(function(a){PhotoPage=new PublicPhotoPage(Query.id,a.info,a,null,"fetch");PhotoPageView=new PublicPhotoPageView(PhotoPage);b.resolve()}).fail(function(a,d){b.reject(d)})}).fail(function(){b.reject("error")})):a("unsupported"):a()})();
Initializer.ready(function(){var a;$("#downloadButton").toggleClass("hidden",!PhotoPage.allowDownload);PhotoPage.allowDownload&&("download"===Query.action?PhotoPage.download():"save"===Query.action&&PhotoPage.saveToCollection("new"));a=$("#whazzat").find(".bubble").bubble({closeAfter:5E3});if(Modernizr.touch)$("#whazzat").on({click:function(){a.open();PubHub.pub("LearnMore/open")}});else $("#whazzat").on({mouseenter:function(){a.open();PubHub.pub("LearnMore/open")}});document.title=$.mustache(PAGE_TITLE_TEMPLATE,
{viewTitle:_(PhotoPageView.makeString("title")).unescape()})});API.define("publicPhotoPageInfo","GET","snapshot_public_info");API.define("photoPageDownload","POST","snapshot_public_download",{includeAuthToken:!1});

//# sourceMappingURL=page.public.js.map
